<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>üå∏ MARLEYS ¬∑ universo secreto</title>
  
  <!-- Fuentes e iconos -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <!-- Firebase Modular -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
      }
    }
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(145deg, #fff5f8, #ffe4ec);
      color: #4a3035;
      padding: 20px;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* HEADER M√ÅGICO */
    .magic-header {
      background: linear-gradient(135deg, #ffb3c6, #ffc1cc);
      border-radius: 80px;
      padding: 35px;
      margin-bottom: 25px;
      border: 5px solid white;
      box-shadow: 0 20px 30px rgba(220, 110, 140, 0.2);
    }

    .magic-title {
      font-size: 3.5rem;
      font-weight: 800;
      color: white;
      text-shadow: 0 5px 0 rgba(180, 80, 100, 0.2);
    }

    /* TARJETAS */
    .card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 50px;
      padding: 30px;
      margin-bottom: 25px;
      border: 3px solid white;
      box-shadow: 0 15px 0 #ffd9e2;
    }

    /* BOTONES */
    .btn {
      border: none;
      padding: 15px 30px;
      border-radius: 60px;
      font-weight: 700;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: 0.2s;
      background: white;
      border: 3px solid transparent;
    }

    .btn-pink {
      background: #ff7a8f;
      color: white;
      box-shadow: 0 8px 0 #b34e62;
    }

    .btn-pink:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 0 #b34e62;
    }

    /* INPUTS */
    .input {
      background: white;
      border: 4px solid #ffe2ec;
      border-radius: 60px;
      padding: 15px 25px;
      font-size: 1rem;
      width: 100%;
      font-family: 'Quicksand', sans-serif;
    }

    .input:focus {
      border-color: #ff7a8f;
      outline: none;
      box-shadow: 0 0 0 8px rgba(255, 122, 143, 0.1);
    }

    /* AVATAR */
    .avatar {
      width: 70px;
      height: 70px;
      background: linear-gradient(145deg, #ffb8c9, #ff90a5);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      font-weight: 700;
      border: 5px solid white;
    }

    /* RESPUESTAS */
    .reply {
      background: #fff2f5;
      border-radius: 30px 30px 30px 10px;
      padding: 20px;
      margin-left: 25px;
      margin-top: 15px;
      border-left: 10px solid #ffb0c0;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 700px) {
      .magic-title { font-size: 2.5rem; }
    }
  </style>
</head>
<body>

<div class="app">

  <!-- HEADER -->
  <div class="magic-header">
    <h1 class="magic-title">üå∏ marleys</h1>
    <div style="display: flex; gap: 15px; margin-top: 15px;">
      <span style="background: rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 60px; backdrop-filter: blur(5px;">
        <i class="fas fa-heart" style="color: #ff4d6d;"></i> solo para ti
      </span>
      <span style="background: white; padding: 10px 20px; border-radius: 60px;" id="onlineCount">
        üë§ 0 aqu√≠
      </span>
    </div>
  </div>

  <!-- SESI√ìN -->
  <div class="card" id="sessionCard">
    <!-- NO LOGUEADA -->
    <div id="notLoggedIn">
      <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
        <span style="font-size: 4rem;">ü¶ã</span>
        <div>
          <h2 style="font-size: 2rem; color: #b54a5a;">hola, marleys</h2>
          <p>elige tu alias para entrar</p>
        </div>
      </div>
      <div style="display: flex; gap: 15px;">
        <input type="text" id="aliasInput" class="input" placeholder="tu alias" value="marleys_" style="flex: 2;">
        <button class="btn btn-pink" id="loginBtn" style="flex: 1;">entrar</button>
      </div>
    </div>
    
    <!-- LOGUEADA -->
    <div id="loggedIn" style="display: none;">
      <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 20px;">
          <div class="avatar" id="avatarDisplay">üå∏</div>
          <div>
            <h2 style="font-size: 1.8rem;" id="userName">marleys</h2>
            <span style="background: #c7f0db; padding: 8px 20px; border-radius: 60px;">‚ú® conectada</span>
          </div>
        </div>
        <button class="btn" id="logoutBtn" style="background: #ffe2ec;">salir</button>
      </div>
    </div>
  </div>

  <!-- ENCUESTA -->
  <div class="card">
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
      <span style="font-size: 2.8rem;">üí≠</span>
      <h2 style="font-size: 1.8rem;">¬øcu√°l es tu plan feliz?</h2>
    </div>
    
    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px;" id="pollButtons">
      <button class="btn poll-btn" data-option="cafe" style="background: #f9e2cf;">‚òï caf√©</button>
      <button class="btn poll-btn" data-option="cine" style="background: #cfe1f0;">üé¨ cine</button>
      <button class="btn poll-btn" data-option="atardecer" style="background: #ffe0b9;">üåÖ atardecer</button>
      <button class="btn poll-btn" data-option="libros" style="background: #ecd8e6;">üìö libros</button>
    </div>
    
    <div id="votedMessage" style="background: #d4edda; padding: 15px; border-radius: 50px; margin-bottom: 20px; display: none;">
      ‚úÖ ya votaste hoy
    </div>
    
    <div style="background: #fff7f9; border-radius: 40px; padding: 25px;">
      <h3>üìä resultados</h3>
      <div id="pollResults" style="margin-top: 20px;">cargando...</div>
    </div>
  </div>

  <!-- MURO -->
  <div class="card">
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
      <span style="font-size: 2.5rem;">üìì</span>
      <h2 style="font-size: 1.8rem;">muro de marleys</h2>
    </div>
    
    <div id="postForm" style="margin-bottom: 30px;">
      <textarea id="messageInput" class="input" placeholder="escribe algo bonito..." rows="2"></textarea>
      <button class="btn btn-pink" id="postBtn" style="margin-top: 15px;">publicar</button>
    </div>
    
    <div id="forumFeed"></div>
  </div>

  <!-- JUEGO -->
  <div class="card">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <span style="font-size: 2.8rem;">‚ö°</span>
        <h2 style="font-size: 1.8rem;">reflejos</h2>
      </div>
      <span style="background: white; padding: 10px 25px; border-radius: 60px;">üèÜ <span id="bestTime">-</span> ms</span>
    </div>
    
    <div id="reactionBox" style="background: #ffdbe4; border-radius: 80px; padding: 50px; margin: 25px 0; text-align: center; font-size: 2.2rem; font-weight: 700; border: 5px solid white; cursor: pointer;">
      üíñ t√≥came
    </div>
    
    <button class="btn btn-pink" id="reactionBtn">comenzar</button>
    <div id="reactionResult" style="margin-top: 15px; font-weight: 600;"></div>
  </div>

  <!-- FOOTER -->
  <div style="text-align: center; margin-top: 40px; color: #a8767e;">
    <p>‚ú® para marleys, con amor ‚ú®</p>
    <p id="footerStatus">conectada como: invitada</p>
  </div>

</div>

<!-- MODAL -->
<div id="welcomeModal" style="display: none; position: fixed; inset: 0; background: rgba(150,70,80,0.2); backdrop-filter: blur(10px); align-items: center; justify-content: center; z-index: 9999;">
  <div style="background: white; max-width: 450px; width: 90%; padding: 40px; border-radius: 80px; text-align: center;">
    <span style="font-size: 4rem;">ü¶ã</span>
    <h2 style="margin: 20px 0; color: #b54a5a; font-size: 2.2rem;">marleys</h2>
    <input type="text" id="modalAlias" class="input" placeholder="tu alias" value="marleys_">
    <button class="btn btn-pink" id="modalLoginBtn" style="width: 100%; margin-top: 20px;">comenzar</button>
  </div>
</div>

<script type="module">
  // ========== FIREBASE ==========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, runTransaction, push, update, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyByB_5gP3sDwbCmVWbiB5CQXHzsKhcDvoo",
    authDomain: "chist-4aac2.firebaseapp.com",
    databaseURL: "https://chist-4aac2-default-rtdb.firebaseio.com",
    projectId: "chist-4aac2",
    storageBucket: "chist-4aac2.firebasestorage.app",
    messagingSenderId: "64011595640",
    appId: "1:64011595640:web:8fa8b005b916cf2af7628d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  console.log("üî• Firebase inicializado");

  // ========== ESTADO ==========
  let currentUser = {
    id: null,
    alias: null,
    isLoggedIn: false
  };

  // ========== FUNCIONES ==========
  function showMsg(msg) {
    const notif = document.createElement('div');
    notif.style.position = 'fixed';
    notif.style.bottom = '20px';
    notif.style.right = '20px';
    notif.style.background = '#ff7a8f';
    notif.style.color = 'white';
    notif.style.padding = '15px 25px';
    notif.style.borderRadius = '50px';
    notif.style.fontWeight = '600';
    notif.style.boxShadow = '0 10px 20px rgba(255,100,130,0.3)';
    notif.style.border = '3px solid white';
    notif.style.zIndex = '999999';
    notif.innerText = msg;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 2500);
  }

  // ========== LOGIN ==========
  async function login(alias) {
    if (!alias || alias.length < 2) {
      showMsg('elige un alias');
      return;
    }
    
    const cleanAlias = alias.trim();
    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2);
    
    currentUser = {
      id: userId,
      alias: cleanAlias,
      isLoggedIn: true
    };
    
    localStorage.setItem('marleysUser', JSON.stringify(currentUser));
    
    try {
      await set(ref(db, `users/${userId}`), {
        id: userId,
        alias: cleanAlias,
        online: true,
        lastActive: Date.now(),
        sessionStart: Date.now()
      });
      
      onDisconnect(ref(db, `users/${userId}`)).update({
        online: false,
        lastActive: Date.now()
      });
      
      updateUI();
      showMsg(`‚ú® bienvenida ${cleanAlias}`);
      checkVoteStatus();
      
    } catch (error) {
      console.error(error);
      showMsg('error de conexi√≥n');
    }
  }

  // ========== LOGOUT ==========
  async function logout() {
    if (currentUser.isLoggedIn) {
      await update(ref(db, `users/${currentUser.id}`), {
        online: false,
        lastActive: Date.now()
      });
    }
    localStorage.removeItem('marleysUser');
    currentUser = { id: null, alias: null, isLoggedIn: false };
    updateUI();
    showMsg('üåô sesi√≥n cerrada');
  }

  // ========== UI ==========
  function updateUI() {
    if (currentUser.isLoggedIn) {
      document.getElementById('notLoggedIn').style.display = 'none';
      document.getElementById('loggedIn').style.display = 'block';
      document.getElementById('postForm').style.display = 'block';
      document.getElementById('userName').innerText = currentUser.alias;
      document.getElementById('avatarDisplay').innerHTML = currentUser.alias.substring(0,2).toUpperCase();
      document.getElementById('footerStatus').innerHTML = `conectada como: <strong>${currentUser.alias}</strong>`;
      document.getElementById('welcomeModal').style.display = 'none';
    } else {
      document.getElementById('notLoggedIn').style.display = 'block';
      document.getElementById('loggedIn').style.display = 'none';
      document.getElementById('postForm').style.display = 'none';
      document.getElementById('footerStatus').innerHTML = 'conectada como: invitada';
    }
  }

  // ========== VOTOS ==========
  async function checkVoteStatus() {
    if (!currentUser.isLoggedIn) return;
    
    const snapshot = await get(ref(db, `pollMarleysVotes/${currentUser.id}`));
    const today = new Date().toDateString();
    
    if (snapshot.exists() && new Date(snapshot.val().timestamp).toDateString() === today) {
      document.getElementById('votedMessage').style.display = 'block';
      document.querySelectorAll('.poll-btn').forEach(b => { 
        b.disabled = true; 
        b.style.opacity = '0.6';
      });
    } else {
      document.getElementById('votedMessage').style.display = 'none';
      document.querySelectorAll('.poll-btn').forEach(b => { 
        b.disabled = false; 
        b.style.opacity = '1';
      });
    }
  }

  async function vote(option) {
    if (!currentUser.isLoggedIn) {
      showMsg('identif√≠cate primero');
      return;
    }
    
    const today = new Date().toDateString();
    const voteRef = ref(db, `pollMarleysVotes/${currentUser.id}`);
    const snap = await get(voteRef);
    
    if (snap.exists() && new Date(snap.val().timestamp).toDateString() === today) {
      showMsg('ya votaste hoy');
      return;
    }
    
    await runTransaction(ref(db, `pollMarleys/${option}`), (v) => (v || 0) + 1);
    await set(voteRef, {
      option,
      timestamp: Date.now(),
      alias: currentUser.alias,
      userId: currentUser.id
    });
    
    showMsg(`votaste: ${option}`);
    checkVoteStatus();
  }

  // ========== PUBLICAR ==========
  async function postMessage() {
    if (!currentUser.isLoggedIn) {
      showMsg('inicia sesi√≥n');
      return;
    }
    
    const text = document.getElementById('messageInput').value.trim();
    if (!text) return;
    
    const newPost = push(ref(db, 'forumComments'));
    await set(newPost, {
      alias: currentUser.alias,
      text,
      timestamp: Date.now(),
      userId: currentUser.id,
      replies: {}
    });
    
    document.getElementById('messageInput').value = '';
    showMsg('mensaje publicado üíï');
  }

  // ========== RESPONDER ==========
  async function reply(commentId, replyText) {
    if (!currentUser.isLoggedIn) {
      showMsg('identif√≠cate');
      return;
    }
    if (!replyText.trim()) return;
    
    const replyId = 'r' + Date.now() + Math.random().toString(36);
    await set(ref(db, `forumComments/${commentId}/replies/${replyId}`), {
      alias: currentUser.alias,
      text: replyText.trim(),
      timestamp: Date.now(),
      userId: currentUser.id
    });
    showMsg('respuesta enviada');
  }

  // ========== RENDER FORO ==========
  function renderForum(snapshot) {
    const feed = document.getElementById('forumFeed');
    
    if (!snapshot.exists()) {
      feed.innerHTML = '<p style="text-align: center; padding: 30px;">üå∏ a√∫n no hay mensajes</p>';
      return;
    }
    
    const comments = Object.entries(snapshot.val())
      .sort((a,b) => b[1].timestamp - a[1].timestamp)
      .slice(0, 15);
    
    let html = '';
    
    for (const [id, comment] of comments) {
      const replies = comment.replies ? Object.values(comment.replies) : [];
      
      let repliesHtml = '';
      replies.forEach(r => {
        repliesHtml += `
          <div class="reply">
            <div style="display: flex; justify-content: space-between;">
              <strong style="color: #b34e62;">${r.alias}</strong>
              <span style="font-size: 0.7rem;">${new Date(r.timestamp).toLocaleTimeString()}</span>
            </div>
            <p style="margin-top: 8px;">${r.text}</p>
          </div>
        `;
      });
      
      html += `
        <div style="background: #fff9fc; border-radius: 40px; padding: 25px; margin-bottom: 25px;">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
            <div style="background: #ffc0cb; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;">
              ${comment.alias ? comment.alias.substring(0,2).toUpperCase() : 'üë§'}
            </div>
            <div>
              <strong style="font-size: 1.1rem;">${comment.alias}</strong>
              <div style="font-size: 0.7rem;">${new Date(comment.timestamp).toLocaleString()}</div>
            </div>
          </div>
          <p style="font-size: 1.1rem; margin-left: 10px; margin-bottom: 20px;">${comment.text}</p>
          
          <button onclick="document.getElementById('replyForm-${id}').style.display='block'" style="background: none; border: none; color: #b34e62; font-weight: 600; cursor: pointer;">
            üí¨ responder
          </button>
          
          <div id="replyForm-${id}" style="display: none; margin-top: 20px;">
            <input type="text" id="replyInput-${id}" class="input" placeholder="tu respuesta..." style="margin-bottom: 10px;">
            <button class="btn btn-pink" style="padding: 10px 20px;" onclick="window.replyTo('${id}')">enviar</button>
            <button class="btn" style="padding: 10px 20px;" onclick="document.getElementById('replyForm-${id}').style.display='none'">cancelar</button>
          </div>
          
          <div style="margin-top: 20px;">
            ${repliesHtml}
          </div>
        </div>
      `;
    }
    
    feed.innerHTML = html;
    
    // Hacer funci√≥n global para respuestas
    window.replyTo = async (commentId) => {
      const input = document.getElementById(`replyInput-${commentId}`);
      await reply(commentId, input.value);
      input.value = '';
      document.getElementById(`replyForm-${commentId}`).style.display = 'none';
    };
  }

  // ========== JUEGO ==========
  let reactionActive = false;
  let reactionStart = null;
  let best = localStorage.getItem('bestReaction') || null;
  
  if (best) document.getElementById('bestTime').innerText = best;
  
  function startReaction() {
    if (!currentUser.isLoggedIn) {
      showMsg('inicia sesi√≥n para jugar');
      return;
    }
    
    reactionActive = true;
    const box = document.getElementById('reactionBox');
    const btn = document.getElementById('reactionBtn');
    
    box.innerText = 'üå∏ espera...';
    box.style.background = '#ffccd5';
    btn.disabled = true;
    
    setTimeout(() => {
      if (!reactionActive) return;
      reactionStart = Date.now();
      box.innerText = 'üí• AHORA!';
      box.style.background = '#ffa5b6';
      box.style.cursor = 'pointer';
      
      box.onclick = () => {
        const time = Date.now() - reactionStart;
        reactionActive = false;
        box.innerText = `‚ö° ${time} ms`;
        box.onclick = null;
        btn.disabled = false;
        
        if (!best || time < parseInt(best)) {
          best = time;
          localStorage.setItem('bestReaction', time);
          document.getElementById('bestTime').innerText = time;
          showMsg('üèÜ nuevo r√©cord');
        }
        document.getElementById('reactionResult').innerHTML = `tiempo: ${time}ms`;
      };
    }, Math.random() * 3000 + 2000);
  }

  // ========== LISTENERS FIREBASE ==========
  function initFirebaseListeners() {
    onValue(ref(db, 'users'), (s) => {
      if (s.exists()) {
        const online = Object.values(s.val()).filter(u => u.online).length;
        document.getElementById('onlineCount').innerHTML = `üë§ ${online} aqu√≠`;
      }
    });
    
    onValue(ref(db, 'pollMarleys'), (s) => {
      const data = s.val() || { cafe:0, cine:0, atardecer:0, libros:0 };
      const total = Object.values(data).reduce((a,b)=>a+b,0);
      let html = '';
      for (let [k,v] of Object.entries(data)) {
        const p = total ? Math.round(v/total*100) : 0;
        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>${k}</span> <span style="background: #ffe4ec; padding: 5px 15px; border-radius: 30px;">${v} (${p}%)</span>
                 </div>`;
      }
      document.getElementById('pollResults').innerHTML = html;
    });
    
    onValue(ref(db, 'forumComments'), renderForum);
  }

  // ========== INIT ==========
  async function init() {
    const saved = localStorage.getItem('marleysUser');
    if (saved) {
      try {
        const u = JSON.parse(saved);
        currentUser = { ...u, isLoggedIn: true };
        await set(ref(db, `users/${u.id}`), {
          id: u.id,
          alias: u.alias,
          online: true,
          lastActive: Date.now(),
          sessionStart: Date.now()
        });
        onDisconnect(ref(db, `users/${u.id}`)).update({ online: false, lastActive: Date.now() });
      } catch(e) {}
    }
    
    updateUI();
    initFirebaseListeners();
    if (currentUser.isLoggedIn) checkVoteStatus();
    
    if (!currentUser.isLoggedIn) {
      setTimeout(() => document.getElementById('welcomeModal').style.display = 'flex', 300);
    }
  }

  // ========== EVENTOS ==========
  document.addEventListener('DOMContentLoaded', init);
  
  document.getElementById('loginBtn').addEventListener('click', () => {
    login(document.getElementById('aliasInput').value);
  });
  
  document.getElementById('modalLoginBtn').addEventListener('click', () => {
    login(document.getElementById('modalAlias').value);
    document.getElementById('welcomeModal').style.display = 'none';
  });
  
  document.getElementById('logoutBtn').addEventListener('click', logout);
  
  document.querySelectorAll('.poll-btn').forEach(b => {
    b.addEventListener('click', () => vote(b.dataset.option));
  });
  
  document.getElementById('postBtn').addEventListener('click', postMessage);
  
  document.getElementById('reactionBtn').addEventListener('click', startReaction);
  
  document.getElementById('welcomeModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('welcomeModal')) {
      document.getElementById('welcomeModal').style.display = 'none';
    }
  });

</script>

</body>
</html>