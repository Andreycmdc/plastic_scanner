<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>‚ú® Marleys Social ¬∑ Red privada</title>
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700;14..32,800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Firebase (modular) -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js"
      }
    }
  </script>
  <style>
    /* ----- üå∏ VARIABLES & RESET (Tono Marleys) ----- */
    :root {
      --primary-soft: #f8e0e8;
      --primary: #d46b7c;
      --primary-deep: #b94e5e;
      --secondary: #a5d8d3;
      --secondary-deep: #67b0a8;
      --accent: #f9c7b7;
      --glow: #ffe7f0;
      --bg: #fff9fb;
      --surface: rgba(255, 245, 248, 0.8);
      --card-bg: rgba(255, 255, 255, 0.8);
      --text-dark: #3c2a2e;
      --text-soft: #6e4b55;
      --text-muted: #a48a90;
      --border-light: #ffdee6;
      --shadow-sm: 0 12px 28px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(255, 220, 230, 0.5);
      --shadow-hover: 0 20px 32px rgba(180, 100, 120, 0.12), 0 0 0 1px rgba(212, 107, 124, 0.3);
      --radius-xl: 28px;
      --radius-lg: 20px;
      --radius-md: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(145deg, #fff3f7 0%, #ffeef5 100%);
      color: var(--text-dark);
      line-height: 1.5;
      min-height: 100vh;
      padding: 20px 16px;
      -webkit-font-smoothing: antialiased;
    }

    /* Glassmorph + burbuja */
    .glass-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1.5px solid rgba(255, 255, 255, 0.7);
      box-shadow: var(--shadow-sm);
      border-radius: var(--radius-lg);
      transition: all 0.25s ease;
    }

    .glass-card:hover {
      box-shadow: var(--shadow-hover);
      border-color: rgba(255, 220, 230, 0.9);
      background: rgba(255, 255, 255, 0.9);
    }

    /* Layout principal */
    .marleys-app {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* üéÄ Cabecera especial ‚Äì dedicada a Marleys */
    .hero-header {
      background: linear-gradient(120deg, #fff1f5, #ffe9ef);
      padding: 28px 30px;
      border-radius: var(--radius-xl);
      margin-bottom: 28px;
      border: 2px solid white;
      box-shadow: 0 10px 25px rgba(212, 107, 124, 0.12);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }

    .hero-header::after {
      content: "üå∏";
      position: absolute;
      right: 20px;
      bottom: -10px;
      font-size: 80px;
      opacity: 0.1;
      transform: rotate(10deg);
    }

    .title-block h1 {
      font-size: 2.4rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      background: linear-gradient(145deg, #b94e5e, #d46b7c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }

    .marleys-badge {
      background: white;
      padding: 6px 18px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary-deep);
      border: 2px solid #ffe2e9;
      display: inline-block;
    }

    .status-area {
      background: rgba(255, 255, 255, 0.7);
      padding: 12px 24px;
      border-radius: 40px;
      border: 1.5px solid white;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .online-dot {
      width: 14px;
      height: 14px;
      background: #5fc98e;
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(95, 201, 142, 0.2);
    }

    /* sesi√≥n */
    .session-panel {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(16px);
      padding: 24px 28px;
      border-radius: var(--radius-lg);
      margin-bottom: 30px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    .user-avatar-large {
      width: 56px;
      height: 56px;
      background: linear-gradient(145deg, var(--primary), #f09a9c);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.5rem;
      border: 3px solid white;
      box-shadow: 0 6px 12px rgba(212, 107, 124, 0.2);
    }

    .btn {
      border: none;
      background: white;
      padding: 12px 26px;
      border-radius: 60px;
      font-weight: 600;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1.5px solid rgba(255, 255, 255, 0.8);
      transition: 0.15s;
      cursor: pointer;
      color: var(--text-dark);
      box-shadow: 0 4px 8px rgba(0,0,0,0.02);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    .btn-primary:hover {
      background: var(--primary-deep);
      transform: scale(0.98);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary-deep);
    }

    /* grid historias + feed */
    .stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .story-card {
      background: linear-gradient(145deg, white, #fff7f9);
      padding: 20px 8px;
      border-radius: 28px;
      text-align: center;
      border: 2px solid white;
      box-shadow: 0 8px 18px #ffdce4;
      transition: 0.2s;
    }

    .story-emoji {
      font-size: 2.5rem;
      margin-bottom: 8px;
    }

    /* feed estilo social */
    .feed {
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .post-card {
      background: white;
      border-radius: var(--radius-xl);
      padding: 24px 26px;
      border: 1px solid #ffe4eb;
      box-shadow: 0 6px 0 #ffe2e9;
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
    }

    .post-avatar {
      width: 48px;
      height: 48px;
      background: #ffdae1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: var(--primary-deep);
    }

    .comment-thread {
      background: #fff9fc;
      border-radius: 20px;
      padding: 16px;
      margin-top: 20px;
    }

    .reply-badge {
      background: #ffedf0;
      border-radius: 40px;
      padding: 6px 14px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* input elegante */
    .input-lovely {
      background: #fff9fb;
      border: 2px solid #ffe4ec;
      border-radius: 40px;
      padding: 14px 20px;
      font-size: 0.95rem;
      width: 100%;
      transition: 0.2s;
    }

    .input-lovely:focus {
      border-color: var(--primary);
      outline: none;
      background: white;
      box-shadow: 0 0 0 4px rgba(212, 107, 124, 0.08);
    }

    /* adaptaci√≥n responsive */
    @media (max-width: 600px) {
      .hero-header h1 { font-size: 1.9rem; }
    }

    /* animaci√≥n tiny */
    @keyframes floatGlow {
      0% { box-shadow: 0 5px 15px rgba(212,107,124,0.1); }
      100% { box-shadow: 0 12px 28px rgba(212,107,124,0.2); }
    }

    .mention-marleys {
      color: var(--primary-deep);
      font-weight: 700;
      background: #ffeef2;
      padding: 2px 8px;
      border-radius: 40px;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="marleys-app">
    <!-- üßÅ Header Superlativo: solo para Marleys -->
    <div class="hero-header">
      <div class="title-block">
        <h1>üå∏ marleys social</h1>
        <span class="marleys-badge"><i class="fas fa-heart" style="color: #d46b7c;"></i> red privada ¬∑ solo para ti</span>
      </div>
      <div class="status-area" id="globalStatus">
        <span class="online-dot"></span>
        <span style="font-weight:600;" id="statusMessage">Conectando...</span>
        <span id="activeUsersBadge" style="background: #ffe6ec; padding: 4px 12px; border-radius: 30px; font-size:0.85rem;"></span>
      </div>
    </div>

    <!-- üë§ SESI√ìN / LOGIN  (dedicado a Marleys)-->
    <div class="session-panel glass-card" id="sessionWidget">
      <!-- Cuando el usuario NO ha iniciado sesi√≥n -->
      <div id="loginPrompt">
        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
          <div style="background: #ffdee6; padding: 14px; border-radius: 60px;">
            <i class="fas fa-smile-wink" style="font-size: 2.2rem; color: #b94e5e;"></i>
          </div>
          <div>
            <h2 style="font-size: 1.5rem; font-weight: 700;">hola, marleys üí≠</h2>
            <p style="color: var(--text-soft);">usa un alias para entrar a tu espacio</p>
          </div>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 18px; flex-wrap: wrap;">
          <input type="text" id="aliasInputMain" class="input-lovely" placeholder="ej. marleys_love" maxlength="20" style="flex:1; min-width: 200px;" value="marleys_">
          <button class="btn btn-primary" id="loginButtonMain"><i class="fas fa-arrow-right-to-bracket"></i> Entrar</button>
        </div>
        <p style="margin-top: 12px; font-size: 0.85rem; color: #a48a90;"><i class="fas fa-lock"></i> solo t√∫ y quienes invites</p>
      </div>

      <!-- Cuando el usuario est√° logueado -->
      <div id="userLoggedPanel" style="display: none; width:100%;">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
          <div style="display: flex; align-items: center; gap: 18px;">
            <div class="user-avatar-large" id="avatarInitials">üå∏</div>
            <div>
              <h3 style="font-weight: 700; margin-bottom: 4px;" id="displayUserAlias">marleys_</h3>
              <span style="background: #dff0ea; padding: 6px 16px; border-radius: 30px; font-size:0.8rem;"><i class="fas fa-circle" style="color: #5fc98e; font-size: 0.7rem;"></i> conectada</span>
            </div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-outline" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> salir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- üåü Historias destacadas (inspiradas en Marleys) -->
    <div style="margin-bottom: 16px;">
      <div style="display: flex; align-items: baseline; justify-content: space-between;">
        <h3 style="font-weight: 700; font-size: 1.3rem;"><i class="fas fa-star" style="color: #f7c35c;"></i> historias de hoy</h3>
        <span style="color: var(--primary); font-size:0.9rem;">solo Marleys puede ver ‚ú®</span>
      </div>
    </div>
    <div class="stories-grid">
      <div class="story-card"><div class="story-emoji">‚òïÔ∏è</div><div style="font-weight:600;">cafecito</div><div style="font-size:0.7rem; color: var(--text-soft);">pendiente</div></div>
      <div class="story-card"><div class="story-emoji">üìñ</div><div style="font-weight:600;">libro</div><div style="font-size:0.7rem; color: var(--text-soft);">recomienda</div></div>
      <div class="story-card"><div class="story-emoji">üéß</div><div style="font-weight:600;">playlist</div><div style="font-size:0.7rem; color: var(--text-soft);">para Marleys</div></div>
      <div class="story-card"><div class="story-emoji">üå∏</div><div style="font-weight:600;">flores</div><div style="font-size:0.7rem; color: var(--text-soft);">tu favoritas</div></div>
    </div>

    <!-- üí¨ FEED PRINCIPAL: red social de Marleys (comentarios, respuestas, encuestas) -->
    <div class="feed" id="socialFeed">
      <!-- 1. Encuesta especial ¬øqu√© plan? -->
      <div class="post-card">
        <div class="post-header">
          <div class="post-avatar"><i class="fas fa-heart" style="font-size:1.6rem;"></i></div>
          <div><span style="font-weight:800; font-size:1.1rem;">pregunta para Marleys</span><span style="display:block; font-size:0.75rem; color: #8f7a7f;">‚ù§Ô∏è responde solo una vez</span></div>
        </div>
        <p style="font-size:1.2rem; font-weight:500; margin-bottom:16px;">¬øqu√© plan te hace m√°s feliz? ü•∫</p>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;" id="pollMarleysOptions">
          <button class="btn" style="background:#fdeff2;" value="cafe"><i class="fas fa-mug-hot"></i> caf√©</button>
          <button class="btn" style="background:#e2f0ed;" value="cine"><i class="fas fa-film"></i> peli</button>
          <button class="btn" style="background:#fff1dd;" value="atardecer"><i class="fas fa-sun"></i> atardecer</button>
          <button class="btn" style="background:#fee7fa;" value="libros"><i class="fas fa-book"></i> librer√≠a</button>
        </div>
        <div id="pollResultsMarleys" style="margin-top: 20px; background: #fff2f5; border-radius: 20px; padding: 16px;">
          <p style="font-weight:600;"><i class="fas fa-chart-simple"></i> votos de tus personas favoritas</p>
          <div id="pollStats">cargando...</div>
        </div>
        <!-- Indicador de voto diario -->
        <div id="pollVoteIndicator" style="margin-top:12px;" class="hidden">‚úÖ ya votaste (vuelve ma√±ana)</div>
      </div>

      <!-- 2. MURO: Pensamientos / confesiones (con respuestas) -->
      <div class="post-card" id="forumSection">
        <div class="post-header">
          <div class="post-avatar"><i class="fas fa-pen-fancy"></i></div>
          <div><span style="font-weight:800;">muro de marleys</span><span style="display:block; font-size:0.8rem;">lo que piensas, siempre bonito</span></div>
        </div>
        <!-- Form comentario -->
        <div id="forumCommentForm" style="display: flex; flex-direction: column; gap:12px; margin-bottom:20px;">
          <textarea class="input-lovely" id="forumMessageInput" placeholder="escribe algo bonito, un recuerdo, lo que quieras..." rows="2" maxlength="400"></textarea>
          <div style="display:flex; justify-content: flex-end;">
            <button class="btn btn-primary" id="postForumBtn" style="background: var(--primary);"><i class="fas fa-paper-plane"></i> publicar</button>
          </div>
        </div>
        <!-- Comentarios + replies -->
        <div style="font-weight:600; margin-bottom:12px;"><i class="fas fa-comment-dots"></i> conversaciones</div>
        <div id="forumCommentsContainer" style="max-height: 500px; overflow-y: auto; padding-right: 6px;">
          <!-- se carga din√°micamente -->
          <p style="color: var(--text-muted);">cargando mensajes...</p>
        </div>
      </div>

      <!-- 3. ESPACIO: recuerdos instant√°neos (juego de reflejos) pero personalizado -->
      <div class="post-card" style="background: linear-gradient(145deg, #fff9fc, #ffffff);">
        <div style="display:flex; align-items:center; gap: 12px; margin-bottom: 20px;">
          <span style="font-size:2.4rem;">‚ö°</span>
          <div><h3 style="font-weight:700;">¬øqu√© tan r√°pido reaccionas?</h3><span style="color: var(--primary-deep);">prueba de reflejos Marleys</span></div>
        </div>
        <div id="reactionBox" style="background: #ffecf0; border-radius: 40px; padding: 40px 16px; text-align: center; font-size: 2.2rem; font-weight: 700; color: #ac5a66; border: 4px solid white; box-shadow: inset 0 4px 10px rgba(0,0,0,0.02); cursor: pointer; transition:0.1s;" class="reaction-ready">
          üíñ marleys
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 18px;">
          <button class="btn" id="reactionStartBtn"><i class="fas fa-play"></i> empezar</button>
          <span style="background: #ffe6ec; padding: 8px 20px; border-radius: 50px;">mejor: <span id="bestReaction">-</span> ms</span>
        </div>
        <div id="reactionFeedback" style="margin-top:16px; font-weight:500; min-height: 32px;"></div>
      </div>
    </div>

    <!-- piecito -->
    <div style="margin-top: 48px; text-align: center; color: #ba9ca0; border-top: 2px dashed #ffdbe2; padding-top: 28px;">
      <p style="font-size: 1.1rem;">üç∞ hecho con mucho ‚ú® para Marleys ‚Äî siempre brilla</p>
      <p style="margin-top: 6px;" id="footerConnection">conectada como <span id="footerAlias">invitada</span></p>
    </div>
  </div>

  <!-- Modal personalizado sutil para primer login -->
  <div id="welcomeMarleysModal" style="display: none; position: fixed; inset:0; background: rgba(0,0,0,0.2); backdrop-filter: blur(6px); align-items: center; justify-content: center; z-index: 999;">
    <div style="background: white; max-width: 400px; padding: 32px; border-radius: 48px; box-shadow: 0 30px 60px rgba(180,100,120,0.2); text-align: center;">
      <span style="font-size: 3.2rem;">üå∏</span>
      <h2 style="margin: 16px 0; color: var(--primary-deep);">bienvenida, Marleys</h2>
      <p style="margin-bottom: 24px;">tu rinc√≥n secreto. entra con tu alias üí≠</p>
      <input type="text" id="modalAliasField" class="input-lovely" placeholder="alias" style="margin-bottom: 16px;" value="marleys_">
      <button class="btn btn-primary" id="modalLoginBtn" style="width:100%;">comenzar</button>
    </div>
  </div>

  <script type="module">
    // üî• FIREBASE (misma config)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, runTransaction, push, update, get, onDisconnect } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByB_5gP3sDwbCmVWbiB5CQXHzsKhcDvoo",
      authDomain: "chist-4aac2.firebaseapp.com",
      databaseURL: "https://chist-4aac2-default-rtdb.firebaseio.com",
      projectId: "chist-4aac2",
      storageBucket: "chist-4aac2.firebasestorage.app",
      messagingSenderId: "64011595640",
      appId: "1:64011595640:web:8fa8b005b916cf2af7628d",
      measurementId: "G-8NXX8FKF54"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ------------------------
    // üå∏ ESTADO GLOBAL (Marleys edition)
    // ------------------------
    let currentUser = {
      id: null,
      alias: null,
      isLoggedIn: false
    };

    // juego reflejos
    let reactionActive = false;
    let reactionStartTime = null;
    let bestTime = localStorage.getItem('marleysBestReaction') || null;
    
    // util: formatear timestamp
    function formatTimeAgo(timestamp) {
      if (!timestamp) return 'ahora';
      const diff = Date.now() - timestamp;
      if (diff < 60000) return 'ahora mismo';
      if (diff < 3600000) return `${Math.floor(diff/60000)} min`;
      if (diff < 86400000) return `${Math.floor(diff/3600000)} h`;
      return new Date(timestamp).toLocaleDateString('es-ES', {day:'numeric', month:'short'});
    }

    // --- actualizar UI sesi√≥n ---
    function updateUIForUser() {
      const loggedInDiv = document.getElementById('userLoggedPanel');
      const loginDiv = document.getElementById('loginPrompt');
      if (currentUser.isLoggedIn) {
        loggedInDiv.style.display = 'flex';
        loginDiv.style.display = 'none';
        document.getElementById('displayUserAlias').innerText = currentUser.alias;
        document.getElementById('footerAlias').innerText = currentUser.alias;
        document.getElementById('avatarInitials').innerHTML = currentUser.alias.substring(0,2).toUpperCase() || 'üë§';
        document.getElementById('statusMessage').innerHTML = 'conectada <span style="font-weight:400;">¬∑ hola Marleys</span>';
        // mostrar form de comentarios
        document.getElementById('forumCommentForm').style.display = 'flex';
      } else {
        loggedInDiv.style.display = 'none';
        loginDiv.style.display = 'flex';
        document.getElementById('footerAlias').innerText = 'invitada';
        document.getElementById('statusMessage').innerHTML = 'desconectada';
        document.getElementById('forumCommentForm').style.display = 'none';
      }
    }

    // login unificado
    async function performLogin(alias) {
      if (!alias || alias.trim().length < 2) { alert('alias muy corto'); return false; }
      const cleanAlias = alias.trim().substring(0,20);
      const userId = 'marleys_' + Date.now() + '_' + Math.random().toString(36).substring(2,6);
      currentUser = { id: userId, alias: cleanAlias, isLoggedIn: true };
      localStorage.setItem('marleysSocialUser', JSON.stringify(currentUser));
      updateUIForUser();
      await initSessionInFirebase();
      checkPollVoteStatus();
      showNotification('üå∏ bienvenida, ' + cleanAlias);
      return true;
    }

    async function initSessionInFirebase() {
      if (!currentUser.isLoggedIn) return;
      const userRef = ref(db, 'users/' + currentUser.id);
      await set(userRef, {
        alias: currentUser.alias,
        online: true,
        lastActive: Date.now(),
        sessionStart: Date.now()
      });
      onDisconnect(userRef).update({ online: false, lastActive: Date.now() });
    }

    // logout
    async function logout() {
      if (currentUser.isLoggedIn) {
        const userRef = ref(db, 'users/' + currentUser.id);
        await update(userRef, { online: false, lastActive: Date.now() });
      }
      localStorage.removeItem('marleysSocialUser');
      currentUser = { id: null, alias: null, isLoggedIn: false };
      updateUIForUser();
      showNotification('sesi√≥n cerrada');
    }

    // -----  ENCUESTA PLAN (voto diario) ----
    async function votePoll(option) {
      if (!currentUser.isLoggedIn) { alert('entra primero'); return; }
      const today = new Date().toDateString();
      const voteRef = ref(db, `pollMarleysVotes/${currentUser.id}`);
      const snap = await get(voteRef);
      if (snap.exists()) {
        const date = new Date(snap.val().timestamp).toDateString();
        if (date === today) {
          showNotification('ya votaste hoy üíï', 'info');
          return;
        }
      }
      // transacci√≥n
      await runTransaction(ref(db, 'pollMarleys/' + option), n => (n || 0) + 1);
      await set(voteRef, { option, timestamp: Date.now(), alias: currentUser.alias });
      document.getElementById('pollVoteIndicator').classList.remove('hidden');
      showNotification('votaste: ' + option);
      checkPollVoteStatus();
    }

    async function checkPollVoteStatus() {
      if (!currentUser.isLoggedIn) return;
      const today = new Date().toDateString();
      const snap = await get(ref(db, `pollMarleysVotes/${currentUser.id}`));
      if (snap.exists() && new Date(snap.val().timestamp).toDateString() === today) {
        document.getElementById('pollVoteIndicator').classList.remove('hidden');
      } else {
        document.getElementById('pollVoteIndicator').classList.add('hidden');
      }
    }

    // ---- foro / muro con respuestas ----
    function renderForumComments(snapshot) {
      const container = document.getElementById('forumCommentsContainer');
      if (!snapshot.exists()) {
        container.innerHTML = '<p style="color: var(--text-muted);">‚ú® a√∫n no hay mensajes, escribe algo bonito</p>';
        return;
      }
      const comments = snapshot.val();
      const sorted = Object.entries(comments).sort((a,b) => b[1].timestamp - a[1].timestamp).slice(0, 20);
      let html = '';
      sorted.forEach(([id, c]) => {
        const replies = c.replies ? Object.values(c.replies).sort((x,y) => x.timestamp - y.timestamp) : [];
        const repliesHtml = replies.map(r => `
          <div style="margin-left: 24px; margin-top: 12px; padding: 12px 16px; background: #fff4f7; border-radius: 24px; border-left: 6px solid #ffd1d9;">
            <div style="display:flex; justify-content: space-between;"><strong>${r.alias || 'an√≥nimo'}</strong> <span style="font-size:0.7rem;">${formatTimeAgo(r.timestamp)}</span></div>
            <p style="margin-top:6px;">${r.text}</p>
          </div>
        `).join('');
        
        html += `
          <div style="background: #fffbfc; border-radius: 28px; padding: 18px; margin-bottom: 24px; border: 1.8px solid white;">
            <div style="display:flex; align-items: center; gap:10px; margin-bottom: 6px;">
              <span style="background: #ffdae2; padding: 6px; border-radius: 50%; width: 36px; height:36px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-user"></i></span>
              <div><span style="font-weight:700;">${c.alias || 'alguien'}</span> <span style="color: var(--text-muted); margin-left: 8px; font-size:0.75rem;">${formatTimeAgo(c.timestamp)}</span></div>
            </div>
            <p style="margin: 8px 0 16px 8px; font-size:1.05rem;">${c.text}</p>
            <div style="display:flex; gap:20px; align-items:center;">
              <button class="reply-btn" style="background:none; border:none; color: #b94e5e; font-weight:600; display:flex; gap:6px;" data-section="forum" data-commentid="${id}"><i class="fas fa-reply"></i> responder</button>
              <span style="font-size:0.8rem;">${replies.length} üí¨</span>
            </div>
            <div id="replyForm-${id}" style="display:none; margin-top:18px;">
              <textarea id="replyInput-${id}" class="input-lovely" placeholder="escribe tu respuesta..." rows="1" style="border-radius: 40px;"></textarea>
              <div style="display:flex; gap:8px; margin-top: 10px;">
                <button class="btn btn-primary send-reply" data-section="forum" data-commentid="${id}" style="padding: 8px 18px;">enviar</button>
                <button class="btn cancel-reply" data-commentid="${id}" style="background:transparent;">cancelar</button>
              </div>
            </div>
            ${repliesHtml}
          </div>
        `;
      });
      container.innerHTML = html;
      
      // attach listeners a reply buttons (din√°mico)
      document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.removeEventListener('click', showReplyFormHandler);
        btn.addEventListener('click', showReplyFormHandler);
      });
      document.querySelectorAll('.send-reply').forEach(btn => {
        btn.removeEventListener('click', sendReplyHandler);
        btn.addEventListener('click', sendReplyHandler);
      });
      document.querySelectorAll('.cancel-reply').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.commentid;
          document.getElementById(`replyForm-${id}`).style.display = 'none';
        });
      });
    }

    function showReplyFormHandler(e) {
      if (!currentUser.isLoggedIn) { alert('entra para responder'); return; }
      const commentId = e.currentTarget.dataset.commentid;
      const form = document.getElementById(`replyForm-${commentId}`);
      if (form) form.style.display = 'block';
    }

    async function sendReplyHandler(e) {
      if (!currentUser.isLoggedIn) { alert('necesitas identificarte'); return; }
      const commentId = e.currentTarget.dataset.commentid;
      const input = document.getElementById(`replyInput-${commentId}`);
      const text = input.value.trim();
      if (!text) return;
      const replyId = 'r_' + Date.now() + '_' + Math.random().toString(36);
      const replyData = {
        alias: currentUser.alias,
        text: text,
        timestamp: Date.now(),
        userId: currentUser.id
      };
      try {
        await set(ref(db, `forumComments/${commentId}/replies/${replyId}`), replyData);
        input.value = '';
        document.getElementById(`replyForm-${commentId}`).style.display = 'none';
        showNotification('respuesta enviada üí¨');
      } catch(e) { console.error(e); }
    }

    // post nuevo en muro
    async function postForumMessage() {
      if (!currentUser.isLoggedIn) { alert('inicia sesi√≥n'); return; }
      const input = document.getElementById('forumMessageInput');
      const text = input.value.trim();
      if (!text) return;
      const newCommentRef = push(ref(db, 'forumComments'));
      await set(newCommentRef, {
        alias: currentUser.alias,
        text: text,
        timestamp: Date.now(),
        userId: currentUser.id,
        replies: {}
      });
      input.value = '';
      showNotification('mensaje publicado üíñ');
    }

    // ---------- JUEGO REACCI√ìN (edici√≥n Marleys) ---------
    function startReaction() {
      if (!currentUser.isLoggedIn) { alert('primero entra, bella'); return; }
      if (reactionActive) return;
      reactionActive = true;
      const box = document.getElementById('reactionBox');
      box.innerText = 'üå∏ espera...';
      box.style.background = '#fde0e6';
      box.style.cursor = 'default';
      document.getElementById('reactionStartBtn').disabled = true;
      const delay = Math.random() * 3000 + 2000;
      setTimeout(() => {
        if (!reactionActive) return;
        reactionStartTime = Date.now();
        box.innerText = 'üí• AHORA!!';
        box.style.background = '#ffcdd9';
        box.style.cursor = 'pointer';
        box.onclick = function reactionHandler() {
          if (!reactionStartTime) return;
          const rt = Date.now() - reactionStartTime;
          reactionActive = false;
          box.onclick = null;
          box.style.background = '#ffecf0';
          box.innerText = `‚ö° ${rt} ms`;
          document.getElementById('reactionStartBtn').disabled = false;
          if (!bestTime || rt < parseInt(bestTime)) {
            bestTime = rt;
            localStorage.setItem('marleysBestReaction', rt);
            document.getElementById('bestReaction').innerText = rt;
            showNotification('¬°nuevo r√©cord! üèÜ');
          } else {
            document.getElementById('bestReaction').innerText = bestTime;
          }
          document.getElementById('reactionFeedback').innerHTML = `tu tiempo: ${rt} ms  ${rt < 280 ? 'üí´ incre√≠ble' : ''}`;
        };
      }, delay);
    }

    // notificaciones
    function showNotification(msg) {
      const notif = document.createElement('div');
      notif.innerText = msg;
      notif.style.position = 'fixed'; notif.style.bottom = '20px'; notif.style.right = '20px';
      notif.style.background = '#d46b7c'; notif.style.color = 'white'; notif.style.padding = '14px 24px';
      notif.style.borderRadius = '60px'; notif.style.fontWeight = '600'; notif.style.zIndex = '9999';
      notif.style.boxShadow = '0 6px 14px rgba(0,0,0,0.1)';
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 2800);
    }

    // ----- FIREBASE LISTENERS -----
    function setupListeners() {
      // usuarios online
      onValue(ref(db, 'users'), (snap) => {
        if (snap.exists()) {
          const users = Object.values(snap.val()).filter(u => u.online).length;
          document.getElementById('activeUsersBadge').innerHTML = `<i class="fas fa-user"></i> ${users} aqu√≠`;
        }
      });
      // resultados encuesta Marleys
      onValue(ref(db, 'pollMarleys'), (snap) => {
        const data = snap.val() || { cafe:0, cine:0, atardecer:0, libros:0 };
        const total = Object.values(data).reduce((a,b)=>a+b,0);
        let html = '';
        for (let [k,v] of Object.entries(data)) {
          const percent = total ? ((v/total)*100).toFixed(0) : 0;
          html += `<div style="display:flex; justify-content:space-between; margin-bottom:6px;"><span>${k} </span><span style="background: #ffdbe4; padding:6px 14px; border-radius:30px;">${v} votos (${percent}%)</span></div>`;
        }
        document.getElementById('pollStats').innerHTML = html || 'sin votos';
      });
      // foro comments con replies
      onValue(ref(db, 'forumComments'), (snap) => renderForumComments(snap));
    }

    // ---------- INIT -------------
    window.addEventListener('DOMContentLoaded', async () => {
      // fecha simb√≥lica
      // check local user
      const saved = localStorage.getItem('marleysSocialUser');
      if (saved) {
        try {
          const u = JSON.parse(saved);
          if (u && u.id && u.alias) {
            currentUser = { id: u.id, alias: u.alias, isLoggedIn: true };
            await initSessionInFirebase();
          }
        } catch(e) {}
      }
      updateUIForUser();
      setupListeners();
      checkPollVoteStatus();
      
      // mejor tiempo reflejo
      if (bestTime) document.getElementById('bestReaction').innerText = bestTime;
      
      // event listeners UI
      document.getElementById('loginButtonMain').addEventListener('click', async () => {
        const alias = document.getElementById('aliasInputMain').value;
        await performLogin(alias);
      });
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // votos encuesta Marleys
      document.querySelectorAll('#pollMarleysOptions .btn').forEach(btn => {
        btn.addEventListener('click', () => votePoll(btn.value));
      });
      // post foro
      document.getElementById('postForumBtn').addEventListener('click', postForumMessage);
      
      // reacci√≥n
      document.getElementById('reactionStartBtn').addEventListener('click', startReaction);
      
      // modal bienvenida (si no est√° logueada, mostramos modal una vez)
      if (!currentUser.isLoggedIn) {
        document.getElementById('welcomeMarleysModal').style.display = 'flex';
      }
      document.getElementById('modalLoginBtn').addEventListener('click', async () => {
        const alias = document.getElementById('modalAliasField').value;
        await performLogin(alias);
        document.getElementById('welcomeMarleysModal').style.display = 'none';
      });
    });
  </script>
</body>
</html>