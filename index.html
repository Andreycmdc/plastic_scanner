<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plastic Scanner Pro - C치mara Trasera</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>
  <style>
    body { background:#0f2027; color:white; font-family:sans-serif; text-align:center; }
    #webcam-container { margin:20px auto; width:400px; height:400px; background:#111; }
    canvas { border-radius:10px; width:100%; height:100%; }
    button { margin:10px; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Plastic Scanner Pro</h1>
  <p>Identifica el tipo de pl치stico con la c치mara trasera</p>

  <div id="webcam-container"></div>
  <div>
    <button id="startBtn">Iniciar C치mara</button>
    <button id="switchCameraBtn">Cambiar C치mara</button>
    <button id="captureBtn" disabled>Capturar</button>
  </div>

  <div id="result">Esperando an치lisis...</div>
  <div id="error" style="color:red;"></div>

  <script>
    const URL = "./model/"; // carpeta de tu modelo
    let model, webcam, maxPredictions, rafId;
    let currentFacingMode = "environment"; 
    let isCameraOn = false;

    const startBtn = document.getElementById("startBtn");
    const switchCameraBtn = document.getElementById("switchCameraBtn");
    const captureBtn = document.getElementById("captureBtn");
    const webcamContainer = document.getElementById("webcam-container");
    const resultEl = document.getElementById("result");
    const errorDiv = document.getElementById("error");

    startBtn.addEventListener("click", init);
    switchCameraBtn.addEventListener("click", switchCamera);
    captureBtn.addEventListener("click", captureAndAnalyze);

    async function init() {
      try {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        webcam = new tmImage.Webcam(400, 400, false);
        await webcam.setup({ facingMode: currentFacingMode });
        await webcam.play();

        webcamContainer.innerHTML = "";
        webcamContainer.appendChild(webcam.canvas);

        isCameraOn = true;
        startBtn.disabled = true;
        captureBtn.disabled = false;

        loop(); // 游댠 IMPORTANTE: inicia el bucle de render
      } catch (err) {
        console.error(err);
        showError("No se pudo iniciar la c치mara. Dale permisos o prueba en HTTPS.");
      }
    }

    async function switchCamera() {
      if (!isCameraOn) return;
      webcam.stop();
      cancelAnimationFrame(rafId);

      currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
      await webcam.setup({ facingMode: currentFacingMode });
      await webcam.play();

      webcamContainer.innerHTML = "";
      webcamContainer.appendChild(webcam.canvas);

      loop(); // reiniciar el bucle
    }

    function loop() {
      webcam.update(); // 游댠 actualiza el frame en el canvas
      rafId = requestAnimationFrame(loop);
    }

    async function captureAndAnalyze() {
      if (!isCameraOn) return;
      try {
        const prediction = await model.predict(webcam.canvas);
        prediction.sort((a, b) => b.probability - a.probability);
        const best = prediction[0];
        resultEl.innerHTML = `游댌 Detectado: <b>${best.className}</b> (${(best.probability*100).toFixed(1)}%)`;
      } catch (err) {
        console.error(err);
        showError("Error al analizar la imagen.");
      }
    }

    function showError(msg) {
      errorDiv.textContent = msg;
      setTimeout(()=> errorDiv.textContent="", 5000);
    }
  </script>
</body>
</html>