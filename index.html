<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>üå∏ MARLEYS ¬∑ tu espacio especial</title>
  
  <!-- Fuentes e iconos preciosos -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <!-- Firebase Modular -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
      }
    }
  </script>
  
  <style>
    /* ====== ESTILOS DE ENSUE√ëO ====== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(145deg, #fff9fa 0%, #ffe9f0 100%);
      color: #4a3b3f;
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    /* Fondo de estrellas flotantes */
    body::before {
      content: "üå∏üå∏üå∏";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.08;
      font-size: 60px;
      letter-spacing: 30px;
      pointer-events: none;
      z-index: 0;
      animation: float 20s infinite linear;
    }

    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
      100% { transform: translateY(0) rotate(0deg); }
    }

    .app-container {
      max-width: 1000px;
      margin: 0 auto;
      position: relative;
      z-index: 10;
    }

    /* ===== TARJETAS DE CRISTAL ===== */
    .crystal-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 40px;
      box-shadow: 0 25px 40px -15px rgba(212, 107, 124, 0.15),
                  inset 0 0 0 1px rgba(255, 255, 255, 0.7);
      padding: 30px;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .crystal-card:hover {
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 30px 50px -15px rgba(180, 80, 100, 0.25);
      transform: translateY(-5px);
    }

    /* ===== HEADER M√ÅGICO ===== */
    .magic-header {
      background: linear-gradient(135deg, #ffb6c1 0%, #ffc0cb 50%, #ffe4e9 100%);
      border-radius: 60px 60px 60px 60px;
      padding: 35px 30px;
      margin-bottom: 30px;
      border: 4px solid white;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 30px rgba(255, 140, 170, 0.2);
    }

    .magic-header::after {
      content: "‚ú®";
      position: absolute;
      bottom: -20px;
      right: -10px;
      font-size: 120px;
      opacity: 0.15;
      transform: rotate(15deg);
    }

    .header-title {
      font-size: 3.2rem;
      font-weight: 700;
      color: white;
      text-shadow: 3px 3px 0 rgba(180, 80, 100, 0.2);
      letter-spacing: -0.5px;
      line-height: 1.1;
      margin-bottom: 8px;
    }

    .header-sub {
      font-size: 1.2rem;
      font-weight: 500;
      color: #fff1f3;
      background: rgba(255, 255, 255, 0.3);
      display: inline-block;
      padding: 8px 25px;
      border-radius: 60px;
      backdrop-filter: blur(5px);
    }

    /* ===== BOTONES DELICATESSEN ===== */
    .btn {
      border: none;
      padding: 14px 28px;
      border-radius: 60px;
      font-weight: 600;
      font-size: 0.95rem;
      font-family: 'Quicksand', sans-serif;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      cursor: pointer;
      transition: 0.25s ease;
      border: 2px solid transparent;
      background: white;
      color: #5a4a4e;
      box-shadow: 0 6px 0 rgba(0,0,0,0.02);
    }

    .btn-primary {
      background: #ff8a9c;
      color: white;
      box-shadow: 0 8px 0 rgba(200, 100, 120, 0.3);
    }

    .btn-primary:hover {
      background: #ff6b81;
      transform: translateY(-2px);
      box-shadow: 0 12px 0 rgba(200, 100, 120, 0.25);
    }

    .btn-primary:active {
      transform: translateY(6px);
      box-shadow: 0 4px 0 rgba(200, 100, 120, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 3px solid #ffb3c1;
      color: #b94e5e;
    }

    .btn-outline:hover {
      background: #ffe7ec;
      border-color: #ff8a9c;
    }

    /* ===== INPUTS PRECIOSOS ===== */
    .input-lovely {
      background: rgba(255, 255, 255, 0.9);
      border: 3px solid #ffe2ec;
      border-radius: 60px;
      padding: 16px 24px;
      font-size: 1rem;
      font-family: 'Quicksand', sans-serif;
      transition: 0.2s;
      width: 100%;
    }

    .input-lovely:focus {
      border-color: #ff8a9c;
      outline: none;
      box-shadow: 0 0 0 6px rgba(255, 138, 156, 0.1);
      background: white;
    }

    /* ===== AVATAR CON AURA ===== */
    .aura-avatar {
      width: 70px;
      height: 70px;
      background: linear-gradient(145deg, #ffb6c1, #ff9aac);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.8rem;
      border: 5px solid white;
      box-shadow: 0 10px 0 rgba(180, 100, 120, 0.1);
    }

    /* ===== FEED DE ENSUE√ëO ===== */
    .dream-post {
      background: white;
      border-radius: 40px;
      padding: 28px;
      margin-bottom: 25px;
      border: 2px solid #ffe4ec;
      box-shadow: 0 15px 0 #ffe2e9;
    }

    .post-author {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .author-avatar-mini {
      width: 50px;
      height: 50px;
      background: linear-gradient(145deg, #ffccd5, #ffb3c1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.3rem;
      border: 3px solid white;
    }

    /* ===== BURBUJAS DE RESPUESTA ===== */
    .reply-bubble {
      background: #fff5f7;
      border-radius: 30px 30px 30px 10px;
      padding: 18px;
      margin-left: 25px;
      margin-top: 15px;
      border-left: 8px solid #ffc1cc;
    }

    /* ===== INDICADORES ===== */
    .online-badge {
      background: #b0e9d0;
      padding: 8px 18px;
      border-radius: 60px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 650px) {
      .magic-header h1 { font-size: 2.4rem; }
      .crystal-card { padding: 20px; }
    }

    .hidden { display: none !important; }
    
    /* Animaciones */
    @keyframes heartBeat {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .heart-icon {
      color: #ff6b8b;
      animation: heartBeat 1.5s infinite;
    }
  </style>
</head>
<body>

<div class="app-container">
  
  <!-- ===== CABECERA ESPECTACULAR ===== -->
  <div class="magic-header">
    <h1 class="header-title">
      üå∏ marleys 
    </h1>
    <span class="header-sub">
      <i class="fas fa-heart heart-icon"></i> solo para ti
    </span>
    <div style="margin-top: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <div class="online-badge" id="globalStatusBadge">
        <i class="fas fa-circle" style="color: #5fc98e; font-size: 0.8rem;"></i> 
        <span id="statusText">Cargando...</span>
      </div>
      <span style="background: white; padding: 6px 20px; border-radius: 60px; font-size: 0.9rem;" id="onlineCountBadge">
        <i class="fas fa-users"></i> 0 aqu√≠
      </span>
    </div>
  </div>

  <!-- ===== PANEL DE IDENTIDAD ===== -->
  <div class="crystal-card" style="margin-bottom: 30px;" id="sessionPanel">
    
    <!-- VISTA: NO LOGEADA -->
    <div id="notLoggedView">
      <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
        <span style="font-size: 3.5rem;">ü¶ã</span>
        <div>
          <h2 style="font-size: 1.9rem; font-weight: 700; color: #b94e5e;">hola, marleys</h2>
          <p style="color: #7a5a62;">identif√≠cate con un alias para entrar</p>
        </div>
      </div>
      <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <input type="text" id="aliasInput" class="input-lovely" placeholder="ej. marleys_amor" maxlength="20" style="flex: 1;" value="marleys_">
        <button class="btn btn-primary" id="loginBtn"><i class="fas fa-arrow-right-to-bracket"></i> entrar</button>
      </div>
    </div>
    
    <!-- VISTA: LOGEADA -->
    <div id="loggedView" style="display: none;">
      <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
        <div style="display: flex; align-items: center; gap: 20px;">
          <div class="aura-avatar" id="avatarDisplay">üå∏</div>
          <div>
            <h3 style="font-size: 1.7rem; font-weight: 700;" id="userAliasDisplay">marleys</h3>
            <span style="background: #dff0ea; padding: 6px 18px; border-radius: 60px;">
              <i class="fas fa-check-circle" style="color: #2e9b5c;"></i> conectada
            </span>
          </div>
        </div>
        <button class="btn btn-outline" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> salir</button>
      </div>
    </div>
  </div>

  <!-- ===== ENCUESTA ESPECIAL PARA MARLEYS ===== -->
  <div class="dream-post">
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
      <span style="font-size: 2.5rem;">üí≠</span>
      <h2 style="font-weight: 700; font-size: 1.6rem;">¬øqu√© plan te hace feliz?</h2>
    </div>
    <p style="margin-bottom: 25px; font-size: 1.1rem;">vota solo una vez al d√≠a, coraz√≥n üíï</p>
    
    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px;" id="pollOptions">
      <button class="btn" value="cafe" style="background: #f5e6d3;"><i class="fas fa-mug-hot"></i> caf√©</button>
      <button class="btn" value="cine" style="background: #d4e1f0;"><i class="fas fa-film"></i> cine</button>
      <button class="btn" value="atardecer" style="background: #ffe0b5;"><i class="fas fa-sun"></i> atardecer</button>
      <button class="btn" value="libros" style="background: #e6d9e2;"><i class="fas fa-book"></i> librer√≠a</button>
    </div>
    
    <div id="alreadyVotedMessage" class="hidden" style="background: #ffe2ec; padding: 14px; border-radius: 40px; margin-bottom: 20px;">
      <i class="fas fa-check-circle"></i> ya votaste hoy, vuelve ma√±ana
    </div>
    
    <div style="background: #fff5f7; border-radius: 40px; padding: 25px;">
      <h3 style="font-weight: 600; margin-bottom: 20px;"><i class="fas fa-chart-pie"></i> resultados</h3>
      <div id="pollResultsContainer">
        <p style="color: #8f7a7f;">cargando...</p>
      </div>
    </div>
  </div>

  <!-- ===== MURO DE PENSAMIENTOS (CON RESPUESTAS) ===== -->
  <div class="dream-post" style="background: #fffbfd;">
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
      <span style="font-size: 2.2rem;">üìù</span>
      <h2 style="font-weight: 700; font-size: 1.6rem;">muro de marleys</h2>
    </div>
    
    <!-- FORM SOLO PARA LOGEADAS -->
    <div id="forumFormContainer" style="margin: 20px 0 30px;">
      <textarea id="forumInput" class="input-lovely" placeholder="escribe un pensamiento, recuerdo o mensaje..." rows="2" maxlength="400"></textarea>
      <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
        <button class="btn btn-primary" id="postForumBtn"><i class="fas fa-feather-alt"></i> publicar</button>
      </div>
    </div>
    
    <!-- LISTA DE MENSAJES + RESPUESTAS -->
    <div id="forumFeed">
      <p style="color: #a48a90; text-align: center;">cargando mensajes bonitos...</p>
    </div>
  </div>

  <!-- ===== JUEGO DE REFLEJOS ===== -->
  <div class="crystal-card" style="background: linear-gradient(145deg, #ffeef2, #fff5f7);">
    <div style="display: flex; align-items: center; gap: 15px;">
      <span style="font-size: 3rem;">‚ö°</span>
      <div>
        <h2 style="font-weight: 700;">prueba de reflejos</h2>
        <p style="color: #8a5a62;">¬øqu√© tan r√°pida eres?</p>
      </div>
    </div>
    
    <div id="reactionBox" style="background: #ffe0e8; border-radius: 60px; padding: 45px 20px; margin: 25px 0; text-align: center; font-size: 2.2rem; font-weight: 700; color: #ac5e6e; border: 5px solid white; cursor: pointer; transition: 0.05s;">
      üíñ t√≥came
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
      <button class="btn btn-primary" id="startReactionBtn"><i class="fas fa-play"></i> comenzar</button>
      <span style="background: white; padding: 10px 20px; border-radius: 60px;">
        üèÜ mejor: <span id="bestTimeDisplay">-</span> ms
      </span>
    </div>
    <div id="reactionFeedback" style="margin-top: 20px; font-size: 1.1rem; min-height: 35px;"></div>
  </div>

  <!-- ===== FOOTER ===== -->
  <div style="margin-top: 50px; text-align: center; color: #ad8c94; border-top: 3px dashed #ffd7df; padding-top: 30px;">
    <p style="font-size: 1.2rem;">‚ú® hecho con todo mi coraz√≥n para marleys ‚ú®</p>
    <p style="margin-top: 10px;" id="footerUserStatus">conectada como: invitada</p>
  </div>
</div>

<!-- ===== MODAL DE BIENVENIDA PRECIOSO ===== -->
<div id="welcomeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.2); backdrop-filter: blur(12px); align-items: center; justify-content: center; z-index: 9999;">
  <div style="background: white; max-width: 450px; width: 90%; padding: 40px; border-radius: 70px; box-shadow: 0 40px 60px rgba(180,100,120,0.2); text-align: center;">
    <span style="font-size: 4rem;">ü¶ã</span>
    <h2 style="margin: 20px 0; color: #b94e5e; font-size: 2rem;">marleys</h2>
    <p style="margin-bottom: 30px; font-size: 1.1rem;">bienvenida a tu rinc√≥n secreto</p>
    <input type="text" id="modalAliasInput" class="input-lovely" placeholder="tu alias" value="marleys_">
    <button class="btn btn-primary" id="modalLoginBtn" style="width: 100%; margin-top: 25px;">comenzar</button>
  </div>
</div>

<script type="module">
  // ========== FIREBASE CONFIGURACI√ìN ==========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, runTransaction, push, update, get, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  // TU CONFIGURACI√ìN (EXACTA)
  const firebaseConfig = {
    apiKey: "AIzaSyByB_5gP3sDwbCmVWbiB5CQXHzsKhcDvoo",
    authDomain: "chist-4aac2.firebaseapp.com",
    databaseURL: "https://chist-4aac2-default-rtdb.firebaseio.com",
    projectId: "chist-4aac2",
    storageBucket: "chist-4aac2.firebasestorage.app",
    messagingSenderId: "64011595640",
    appId: "1:64011595640:web:8fa8b005b916cf2af7628d"
  };

  // INICIALIZAR FIREBASE
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  console.log("üî• Firebase conectado correctamente");

  // ========== ESTADO GLOBAL ==========
  let currentUser = {
    id: null,
    alias: null,
    isLoggedIn: false
  };

  // Mejor tiempo de reacci√≥n
  let bestReactionTime = localStorage.getItem('marleysBestTime') || null;
  if (bestReactionTime) document.getElementById('bestTimeDisplay').innerText = bestReactionTime;

  // ========== FUNCIONES DE UTILIDAD ==========
  function formatTimeAgo(timestamp) {
    if (!timestamp) return 'ahora';
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'ahora mismo';
    if (seconds < 3600) return `${Math.floor(seconds / 60)} min`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} h`;
    return new Date(timestamp).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
  }

  function showNotification(message, type = 'happy') {
    const notif = document.createElement('div');
    notif.innerHTML = `<i class="fas fa-heart" style="margin-right: 8px;"></i> ${message}`;
    notif.style.position = 'fixed';
    notif.style.bottom = '25px';
    notif.style.right = '25px';
    notif.style.background = type === 'happy' ? '#ff8a9c' : '#b0c4de';
    notif.style.color = 'white';
    notif.style.padding = '16px 28px';
    notif.style.borderRadius = '80px';
    notif.style.fontWeight = '600';
    notif.style.boxShadow = '0 15px 25px rgba(255, 100, 130, 0.3)';
    notif.style.zIndex = '99999';
    notif.style.backdropFilter = 'blur(10px)';
    notif.style.border = '2px solid white';
    notif.style.animation = 'heartBeat 0.5s';
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 2800);
  }

  // ========== SESI√ìN ==========
  async function login(alias) {
    if (!alias || alias.trim().length < 2) {
      showNotification('elige un alias bonito', 'error');
      return false;
    }
    
    const cleanAlias = alias.trim().substring(0, 20);
    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);
    
    currentUser = {
      id: userId,
      alias: cleanAlias,
      isLoggedIn: true
    };
    
    // Guardar en localStorage
    localStorage.setItem('marleysUser', JSON.stringify(currentUser));
    
    // Guardar en Firebase
    const userRef = ref(db, `users/${userId}`);
    await set(userRef, {
      id: userId,
      alias: cleanAlias,
      online: true,
      lastActive: Date.now(),
      sessionStart: Date.now()
    });
    
    // Desconexi√≥n autom√°tica
    onDisconnect(userRef).update({
      online: false,
      lastActive: Date.now()
    });
    
    updateUI();
    showNotification(`‚ú® bienvenida, ${cleanAlias}`);
    return true;
  }

  async function logout() {
    if (currentUser.isLoggedIn) {
      const userRef = ref(db, `users/${currentUser.id}`);
      await update(userRef, { online: false, lastActive: Date.now() });
    }
    localStorage.removeItem('marleysUser');
    currentUser = { id: null, alias: null, isLoggedIn: false };
    updateUI();
    showNotification('üåô sesi√≥n cerrada');
  }

  // ========== UI ==========
  function updateUI() {
    const notLogged = document.getElementById('notLoggedView');
    const logged = document.getElementById('loggedView');
    const forumForm = document.getElementById('forumFormContainer');
    const footerStatus = document.getElementById('footerUserStatus');
    
    if (currentUser.isLoggedIn) {
      notLogged.style.display = 'none';
      logged.style.display = 'block';
      forumForm.style.display = 'block';
      document.getElementById('userAliasDisplay').innerText = currentUser.alias;
      document.getElementById('avatarDisplay').innerHTML = currentUser.alias.substring(0, 2).toUpperCase() || 'üå∏';
      footerStatus.innerHTML = `conectada como: <strong>${currentUser.alias}</strong>`;
      
      // Ocultar modal si est√° visible
      document.getElementById('welcomeModal').style.display = 'none';
    } else {
      notLogged.style.display = 'block';
      logged.style.display = 'none';
      forumForm.style.display = 'none';
      footerStatus.innerHTML = 'conectada como: invitada';
    }
  }

  // ========== VERIFICAR VOTO DIARIO ==========
  async function checkDailyVote() {
    if (!currentUser.isLoggedIn) return;
    
    const today = new Date().toDateString();
    const voteRef = ref(db, `pollMarleysVotes/${currentUser.id}`);
    
    try {
      const snapshot = await get(voteRef);
      if (snapshot.exists()) {
        const voteData = snapshot.val();
        const voteDate = new Date(voteData.timestamp).toDateString();
        
        if (voteDate === today) {
          document.getElementById('alreadyVotedMessage').classList.remove('hidden');
          // Deshabilitar botones
          document.querySelectorAll('#pollOptions .btn').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.6';
          });
        } else {
          document.getElementById('alreadyVotedMessage').classList.add('hidden');
          document.querySelectorAll('#pollOptions .btn').forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
          });
        }
      } else {
        document.getElementById('alreadyVotedMessage').classList.add('hidden');
        document.querySelectorAll('#pollOptions .btn').forEach(btn => {
          btn.disabled = false;
          btn.style.opacity = '1';
        });
      }
    } catch (error) {
      console.error('Error verificando voto:', error);
    }
  }

  // ========== VOTAR ENCUESTA ==========
  async function votePoll(option) {
    if (!currentUser.isLoggedIn) {
      showNotification('primero identif√≠cate üíï');
      return;
    }
    
    const today = new Date().toDateString();
    const voteRef = ref(db, `pollMarleysVotes/${currentUser.id}`);
    
    try {
      const snapshot = await get(voteRef);
      if (snapshot.exists()) {
        const voteDate = new Date(snapshot.val().timestamp).toDateString();
        if (voteDate === today) {
          showNotification('ya votaste hoy, vuelve ma√±ana üå∏');
          return;
        }
      }
      
      // Registrar voto en el contador
      await runTransaction(ref(db, `pollMarleys/${option}`), (current) => {
        return (current || 0) + 1;
      });
      
      // Registrar voto del usuario
      await set(voteRef, {
        option: option,
        timestamp: Date.now(),
        alias: currentUser.alias,
        userId: currentUser.id
      });
      
      showNotification(`votaste: ${option} üíñ`);
      checkDailyVote();
      
    } catch (error) {
      console.error('Error al votar:', error);
      showNotification('error al votar');
    }
  }

  // ========== PUBLICAR EN MURO ==========
  async function postForumMessage() {
    if (!currentUser.isLoggedIn) {
      showNotification('identif√≠cate para publicar');
      return;
    }
    
    const input = document.getElementById('forumInput');
    const text = input.value.trim();
    
    if (text.length === 0) {
      showNotification('escribe algo bonito');
      return;
    }
    
    if (text.length > 400) {
      showNotification('mensaje muy largo');
      return;
    }
    
    try {
      const newPostRef = push(ref(db, 'forumComments'));
      await set(newPostRef, {
        alias: currentUser.alias,
        text: text,
        timestamp: Date.now(),
        userId: currentUser.id,
        replies: {}
      });
      
      input.value = '';
      showNotification('mensaje publicado ‚ú®');
      
    } catch (error) {
      console.error('Error publicando:', error);
      showNotification('error al publicar');
    }
  }

  // ========== RESPONDER A COMENTARIO ==========
  async function postReply(commentId, replyText) {
    if (!currentUser.isLoggedIn) {
      showNotification('identif√≠cate para responder');
      return;
    }
    
    if (!replyText || replyText.trim().length === 0) return;
    
    try {
      const replyId = 'reply_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6);
      const replyRef = ref(db, `forumComments/${commentId}/replies/${replyId}`);
      
      await set(replyRef, {
        alias: currentUser.alias,
        text: replyText.trim(),
        timestamp: Date.now(),
        userId: currentUser.id
      });
      
      showNotification('respondiste üí¨');
      
    } catch (error) {
      console.error('Error al responder:', error);
      showNotification('error al responder');
    }
  }

  // ========== RENDERIZAR FORO ==========
  function renderForum(snapshot) {
    const feed = document.getElementById('forumFeed');
    
    if (!snapshot.exists()) {
      feed.innerHTML = '<div style="text-align: center; padding: 30px; color: #a48a90;">üå∏ a√∫n no hay mensajes, escribe algo hermoso</div>';
      return;
    }
    
    const comments = snapshot.val();
    const sorted = Object.entries(comments)
      .sort((a, b) => b[1].timestamp - a[1].timestamp)
      .slice(0, 20);
    
    let html = '';
    
    for (const [commentId, comment] of sorted) {
      const replies = comment.replies ? Object.values(comment.replies).sort((a, b) => a.timestamp - b.timestamp) : [];
      
      let repliesHtml = '';
      replies.forEach(reply => {
        repliesHtml += `
          <div class="reply-bubble">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="font-weight: 700; color: #b94e5e;">${reply.alias || 'an√≥nimo'}</span>
              <span style="font-size: 0.75rem; color: #a18489;">${formatTimeAgo(reply.timestamp)}</span>
            </div>
            <p style="font-size: 0.98rem;">${reply.text}</p>
          </div>
        `;
      });
      
      html += `
        <div style="background: #fff9fc; border-radius: 35px; padding: 22px; margin-bottom: 25px; border: 2px solid white;">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px;">
            <div class="author-avatar-mini">${comment.alias ? comment.alias.substring(0,2).toUpperCase() : 'üë§'}</div>
            <div>
              <span style="font-weight: 700; font-size: 1.1rem;">${comment.alias || 'alguien'}</span>
              <span style="display: block; font-size: 0.7rem; color: #a48a90;">${formatTimeAgo(comment.timestamp)}</span>
            </div>
          </div>
          
          <p style="font-size: 1.1rem; margin: 8px 0 20px 10px;">${comment.text}</p>
          
          <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 10px;">
            <button class="reply-trigger-btn" data-commentid="${commentId}" style="background: none; border: none; color: #b94e5e; font-weight: 600; display: flex; gap: 5px; cursor: pointer;">
              <i class="fas fa-reply"></i> responder
            </button>
            <span style="font-size: 0.85rem; color: #8f7a7f;">${replies.length} respuestas</span>
          </div>
          
          <!-- FORMULARIO DE RESPUESTA OCULTO -->
          <div id="replyForm-${commentId}" style="display: none; margin: 15px 0 20px;">
            <textarea id="replyInput-${commentId}" class="input-lovely" placeholder="escribe tu respuesta..." rows="1" style="border-radius: 30px;"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <button class="btn btn-primary send-reply-btn" data-commentid="${commentId}" style="padding: 10px 22px;">enviar</button>
              <button class="btn cancel-reply-btn" data-commentid="${commentId}" style="background: #f0e2e5;">cancelar</button>
            </div>
          </div>
          
          <!-- RESPUESTAS EXISTENTES -->
          <div style="margin-top: 15px;">
            ${repliesHtml}
          </div>
        </div>
      `;
    }
    
    feed.innerHTML = html;
    
    // Adjuntar event listeners a botones de respuesta
    document.querySelectorAll('.reply-trigger-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const commentId = e.currentTarget.dataset.commentid;
        const form = document.getElementById(`replyForm-${commentId}`);
        if (form) form.style.display = 'block';
      });
    });
    
    document.querySelectorAll('.cancel-reply-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const commentId = e.currentTarget.dataset.commentid;
        const form = document.getElementById(`replyForm-${commentId}`);
        if (form) {
          form.style.display = 'none';
          document.getElementById(`replyInput-${commentId}`).value = '';
        }
      });
    });
    
    document.querySelectorAll('.send-reply-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const commentId = e.currentTarget.dataset.commentid;
        const input = document.getElementById(`replyInput-${commentId}`);
        await postReply(commentId, input.value.trim());
        input.value = '';
        document.getElementById(`replyForm-${commentId}`).style.display = 'none';
      });
    });
  }

  // ========== JUEGO DE REACCI√ìN ==========
  let reactionActive = false;
  let reactionStartTime = null;
  
  function startReactionGame() {
    if (!currentUser.isLoggedIn) {
      showNotification('identif√≠cate para jugar');
      return;
    }
    
    if (reactionActive) return;
    
    reactionActive = true;
    const box = document.getElementById('reactionBox');
    const btn = document.getElementById('startReactionBtn');
    
    box.innerText = 'üå∏ espera...';
    box.style.background = '#ffd1dc';
    box.style.cursor = 'default';
    btn.disabled = true;
    
    const delay = Math.random() * 3000 + 2000;
    
    setTimeout(() => {
      if (!reactionActive) return;
      
      reactionStartTime = Date.now();
      box.innerText = 'üí• AHORA!';
      box.style.background = '#ffb3c1';
      box.style.cursor = 'pointer';
      
      box.onclick = function() {
        if (!reactionStartTime) return;
        
        const reactionTime = Date.now() - reactionStartTime;
        reactionActive = false;
        box.onclick = null;
        box.style.background = '#ffe0e8';
        box.innerText = `‚ö° ${reactionTime} ms`;
        btn.disabled = false;
        
        if (!bestReactionTime || reactionTime < parseInt(bestReactionTime)) {
          bestReactionTime = reactionTime;
          localStorage.setItem('marleysBestTime', reactionTime);
          document.getElementById('bestTimeDisplay').innerText = reactionTime;
          showNotification('üèÜ nuevo r√©cord!');
        }
        
        document.getElementById('reactionFeedback').innerHTML = `tiempo: ${reactionTime} ms`;
      };
    }, delay);
  }

  // ========== LISTENERS DE FIREBASE ==========
  function setupFirebaseListeners() {
    // Usuarios online
    onValue(ref(db, 'users'), (snapshot) => {
      if (snapshot.exists()) {
        const users = Object.values(snapshot.val()).filter(u => u.online === true).length;
        document.getElementById('onlineCountBadge').innerHTML = `<i class="fas fa-users"></i> ${users} aqu√≠`;
        document.getElementById('statusText').innerText = users > 0 ? 'conectada' : 'solo t√∫';
      }
    });
    
    // Resultados encuesta
    onValue(ref(db, 'pollMarleys'), (snapshot) => {
      const data = snapshot.val() || { cafe: 0, cine: 0, atardecer: 0, libros: 0 };
      const total = Object.values(data).reduce((a, b) => a + b, 0);
      
      let html = '';
      for (const [key, value] of Object.entries(data)) {
        const percent = total > 0 ? Math.round((value / total) * 100) : 0;
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; text-transform: capitalize;">${key}</span>
            <span style="background: #ffe4ec; padding: 6px 18px; border-radius: 60px;">
              ${value} votos (${percent}%)
            </span>
          </div>
        `;
      }
      document.getElementById('pollResultsContainer').innerHTML = html || '<p>sin votos a√∫n</p>';
    });
    
    // Foro con respuestas
    onValue(ref(db, 'forumComments'), (snapshot) => {
      renderForum(snapshot);
    });
  }

  // ========== INICIALIZACI√ìN ==========
  async function init() {
    console.log('‚ú® Iniciando aplicaci√≥n para Marleys');
    
    // Verificar usuario guardado
    const savedUser = localStorage.getItem('marleysUser');
    if (savedUser) {
      try {
        const parsed = JSON.parse(savedUser);
        if (parsed && parsed.id && parsed.alias) {
          currentUser = { ...parsed, isLoggedIn: true };
          
          // Reactivar sesi√≥n en Firebase
          const userRef = ref(db, `users/${currentUser.id}`);
          await set(userRef, {
            id: currentUser.id,
            alias: currentUser.alias,
            online: true,
            lastActive: Date.now(),
            sessionStart: Date.now()
          });
          
          onDisconnect(userRef).update({ online: false, lastActive: Date.now() });
        }
      } catch (e) {
        console.error('Error cargando usuario:', e);
      }
    }
    
    updateUI();
    setupFirebaseListeners();
    checkDailyVote();
    
    // Mostrar modal si no est√° logueada
    if (!currentUser.isLoggedIn) {
      setTimeout(() => {
        document.getElementById('welcomeModal').style.display = 'flex';
      }, 300);
    }
  }

  // ========== EVENT LISTENERS ==========
  document.addEventListener('DOMContentLoaded', init);
  
  // Login
  document.getElementById('loginBtn').addEventListener('click', () => {
    const alias = document.getElementById('aliasInput').value;
    login(alias);
  });
  
  document.getElementById('modalLoginBtn').addEventListener('click', () => {
    const alias = document.getElementById('modalAliasInput').value;
    login(alias);
  });
  
  // Logout
  document.getElementById('logoutBtn').addEventListener('click', logout);
  
  // Votar encuesta
  document.querySelectorAll('#pollOptions .btn').forEach(btn => {
    btn.addEventListener('click', () => votePoll(btn.value));
  });
  
  // Publicar en muro
  document.getElementById('postForumBtn').addEventListener('click', postForumMessage);
  
  // Enter en textarea de foro
  document.getElementById('forumInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      postForumMessage();
    }
  });
  
  // Juego de reacci√≥n
  document.getElementById('startReactionBtn').addEventListener('click', startReactionGame);
  
  // Cerrar modal al hacer click fuera
  document.getElementById('welcomeModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('welcomeModal')) {
      document.getElementById('welcomeModal').style.display = 'none';
    }
  });

</script>

</body>
</html>