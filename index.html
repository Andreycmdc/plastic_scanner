<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>üå∏ MARLEYS SOCIAL ¬∑ red emocional</title>
  
  <!-- Firebase Modular -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
      }
    }
  </script>
  
  <style>
    /* ===== ESTILOS DE ENSUE√ëO ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Quicksand', 'Inter', sans-serif;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap');
    
    body {
      background: linear-gradient(145deg, #fff5f8, #ffe4ec);
      color: #4a3035;
      padding: 16px;
      min-height: 100vh;
    }
    
    .app {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    }
    
    /* ===== TARJETAS DE CRISTAL ===== */
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 3px solid rgba(255, 255, 255, 0.9);
      border-radius: 40px;
      box-shadow: 0 20px 30px -10px rgba(180, 90, 110, 0.15);
      padding: 25px;
      transition: all 0.3s;
    }
    
    .glass-card:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: translateY(-5px);
      box-shadow: 0 30px 40px -10px rgba(180, 90, 110, 0.25);
    }
    
    /* ===== HEADER M√ÅGICO ===== */
    .magic-header {
      background: linear-gradient(135deg, #ffb6c1, #ff9aac);
      border-radius: 60px;
      padding: 30px;
      margin-bottom: 25px;
      border: 6px solid white;
      box-shadow: 0 20px 0 rgba(180, 80, 100, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .magic-header::after {
      content: "üå∏‚ú®";
      position: absolute;
      bottom: -20px;
      right: -10px;
      font-size: 90px;
      opacity: 0.2;
      transform: rotate(15deg);
    }
    
    .glow-title {
      font-size: 3.2rem;
      font-weight: 800;
      color: white;
      text-shadow: 0 8px 0 rgba(150, 60, 80, 0.2);
      letter-spacing: -1px;
    }
    
    /* ===== BOTONES ===== */
    .btn {
      border: none;
      padding: 14px 28px;
      border-radius: 60px;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      transition: 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: white;
      border: 3px solid transparent;
    }
    
    .btn-primary {
      background: #ff7a8f;
      color: white;
      box-shadow: 0 8px 0 #b34e62;
    }
    
    .btn-primary:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 0 #b34e62;
    }
    
    .btn-success {
      background: #7ac9a0;
      color: white;
      box-shadow: 0 8px 0 #4f8a6e;
    }
    
    .btn-outline {
      background: transparent;
      border: 3px solid #ffb6c1;
      color: #b34e62;
    }
    
    /* ===== INPUTS ===== */
    .input {
      background: white;
      border: 4px solid #ffe2ec;
      border-radius: 60px;
      padding: 16px 24px;
      font-size: 1rem;
      width: 100%;
      transition: 0.2s;
    }
    
    .input:focus {
      border-color: #ff7a8f;
      outline: none;
      box-shadow: 0 0 0 8px rgba(255, 122, 143, 0.1);
    }
    
    /* ===== AVATARES ===== */
    .avatar {
      width: 60px;
      height: 60px;
      background: linear-gradient(145deg, #ffb8c9, #ff90a5);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.8rem;
      border: 5px solid white;
      box-shadow: 0 8px 0 rgba(180, 80, 100, 0.15);
    }
    
    .avatar-sm {
      width: 45px;
      height: 45px;
      font-size: 1.3rem;
      border-width: 3px;
    }
    
    /* ===== BURBUJAS DE CHAT ===== */
    .chat-bubble-mine {
      background: #ff7a8f;
      color: white;
      padding: 16px 24px;
      border-radius: 30px 30px 10px 30px;
      max-width: 80%;
      align-self: flex-end;
      margin-left: auto;
      border: 3px solid white;
    }
    
    .chat-bubble-other {
      background: white;
      color: #4a3035;
      padding: 16px 24px;
      border-radius: 30px 30px 30px 10px;
      max-width: 80%;
      align-self: flex-start;
      border: 3px solid #ffe2ec;
    }
    
    /* ===== TARJETA DE USUARIO ===== */
    .user-card {
      background: white;
      border-radius: 30px;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      border: 3px solid #ffe2ec;
      transition: 0.2s;
    }
    
    .user-card:hover {
      border-color: #ffb6c1;
      transform: scale(1.02);
    }
    
    /* ===== BADGES ===== */
    .badge {
      background: #ffe2ec;
      padding: 6px 16px;
      border-radius: 60px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .badge-online {
      background: #c7f0db;
      color: #1f8b4c;
    }
    
    /* ===== ANIMACIONES ===== */
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    .float-animation {
      animation: float 3s infinite;
    }
    
    /* ===== LAYOUT ===== */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 25px;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 25px;
    }
    
    @media (max-width: 900px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .glow-title { font-size: 2.5rem; }
    }
    
    /* ===== DIARIO PRIVADO ===== */
    .diario-entry {
      background: #fff9e6;
      border-radius: 30px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 12px solid #ffb6c1;
    }
    
    /* ===== NOTIFICACI√ìN ===== */
    .notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #ff7a8f;
      color: white;
      padding: 18px 32px;
      border-radius: 80px;
      font-weight: 600;
      border: 5px solid white;
      box-shadow: 0 12px 0 #b34e62;
      z-index: 9999;
      animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .hidden { display: none !important; }
    
    /* ===== SECCI√ìN DE CHAT ===== */
    .chat-container {
      height: 400px;
      overflow-y: auto;
      padding: 20px;
      background: #fff7f9;
      border-radius: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    /* ===== SECCI√ìN DE JUEGOS ===== */
    .game-card {
      background: linear-gradient(145deg, #ffe9ef, #fff5f8);
      border-radius: 30px;
      padding: 25px;
      text-align: center;
      border: 4px solid white;
    }
    
    .reaction-box {
      background: #ffdbe4;
      border-radius: 60px;
      padding: 35px;
      font-size: 2rem;
      font-weight: 700;
      border: 6px solid white;
      cursor: pointer;
      transition: 0.05s;
    }
  </style>
</head>
<body>

<div class="app">

  <!-- ===== HEADER M√ÅGICO ===== -->
  <div class="magic-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
      <div>
        <h1 class="glow-title">üå∏ marleys social</h1>
        <div style="display: flex; gap: 12px; margin-top: 12px;">
          <span class="badge" style="background: rgba(255,255,255,0.3); backdrop-filter: blur(5px); color: white; border: 2px solid white;">
            <i class="fas fa-heart"></i> red emocional
          </span>
          <span class="badge" id="globalOnlineBadge" style="background: white; color: #b34e62;">
            <i class="fas fa-users"></i> <span id="onlineCount">0</span> conectados
          </span>
        </div>
      </div>
      <div id="headerUserInfo" style="display: none;">
        <!-- Se llena con JS -->
      </div>
    </div>
  </div>

  <!-- ===== PANEL DE IDENTIDAD ===== -->
  <div class="glass-card" style="margin-bottom: 25px;" id="sessionPanel">
    <!-- NO LOGEADO -->
    <div id="notLoggedView">
      <div style="display: flex; align-items: center; gap: 25px; flex-wrap: wrap;">
        <span style="font-size: 4.5rem;">ü¶ã</span>
        <div style="flex: 1;">
          <h2 style="font-size: 2.2rem; color: #b54a5a; margin-bottom: 8px;">hola, marleys</h2>
          <p style="color: #6a4e54; font-size: 1.1rem; margin-bottom: 20px;">crea tu identidad en esta red emocional</p>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <input type="text" id="registerAliasInput" class="input" placeholder="tu alias" style="flex: 2;" value="marleys_">
            <button class="btn btn-primary" id="registerBtn" style="flex: 1;"><i class="fas fa-heart"></i> comenzar</button>
          </div>
          <p style="margin-top: 15px; font-size: 0.9rem; color: #8f6f77;"><i class="fas fa-shield-alt"></i> tu espacio seguro</p>
        </div>
      </div>
    </div>
    
    <!-- LOGEADO -->
    <div id="loggedView" style="display: none;">
      <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
        <div style="display: flex; align-items: center; gap: 20px;">
          <div class="avatar" id="userAvatar">üå∏</div>
          <div>
            <h2 style="font-size: 1.8rem; font-weight: 700;" id="userNameDisplay">marleys</h2>
            <div style="display: flex; gap: 12px; margin-top: 8px;">
              <span class="badge badge-online"><i class="fas fa-circle"></i> conectada</span>
              <span class="badge" id="userMoodBadge"><i class="fas fa-smile"></i> feliz</span>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-outline" id="openDiarioBtn"><i class="fas fa-book"></i> diario</button>
          <button class="btn" id="logoutBtn" style="background: #ffe2ec;">salir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== PANEL PRINCIPAL: SOLO VISIBLE LOGEADO ===== -->
  <div id="mainAppContent" style="display: none;">
    
    <!-- ===== SECCI√ìN: ESTADO EMOCIONAL ===== -->
    <div class="glass-card" style="margin-bottom: 25px; background: linear-gradient(145deg, #ffe9ef, white);">
      <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <span style="font-size: 2.2rem;">üíó</span>
          <h3 style="font-weight: 700;">¬øc√≥mo te sientes hoy?</h3>
        </div>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn mood-btn" data-mood="feliz" style="background: #ffe87c;">üòä feliz</button>
          <button class="btn mood-btn" data-mood="tranquila" style="background: #a5d8d3;">üòå tranquila</button>
          <button class="btn mood-btn" data-mood="nostalgica" style="background: #e2cfeb;">ü•∫ nost√°lgica</button>
          <button class="btn mood-btn" data-mood="energetica" style="background: #ffb3b3;">‚ö° energ√©tica</button>
        </div>
      </div>
    </div>

    <!-- ===== GRID PRINCIPAL: 2 COLUMNAS ===== -->
    <div class="grid-2">
      
      <!-- COLUMNA IZQUIERDA: USUARIOS + SOLICITUDES + CHAT -->
      <div>
        <!-- BUSCADOR DE USUARIOS -->
        <div class="glass-card" style="margin-bottom: 25px;">
          <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-user-friends"></i> conectar con alguien
          </h3>
          <input type="text" id="userSearchInput" class="input" placeholder="buscar por alias..." style="margin-bottom: 20px;">
          <div id="usersListContainer" style="max-height: 300px; overflow-y: auto; padding-right: 8px;">
            <!-- Se llena con JS -->
            <p style="color: #a8767e; text-align: center;">cargando usuarios...</p>
          </div>
        </div>
        
        <!-- SOLICITUDES PENDIENTES -->
        <div class="glass-card" style="margin-bottom: 25px;">
          <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-bell"></i> solicitudes <span id="pendingRequestsBadge" style="background: #ff7a8f; color: white; padding: 4px 12px; border-radius: 60px; font-size: 0.8rem;">0</span>
          </h3>
          <div id="pendingRequestsContainer">
            <p style="color: #a8767e; text-align: center;">no hay solicitudes</p>
          </div>
        </div>
        
        <!-- CHAT PRIVADO (SOLO CON USUARIOS CONECTADOS) -->
        <div class="glass-card" id="chatSection">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <h3 style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-comments"></i> chat privado
            </h3>
            <select id="chatUserSelect" class="badge" style="padding: 10px 20px; border: 2px solid #ffe2ec;">
              <option value="">selecciona un contacto</option>
            </select>
          </div>
          
          <!-- CONTENEDOR DE MENSAJES -->
          <div id="chatMessagesContainer" class="chat-container" style="margin-bottom: 15px;">
            <p style="color: #a8767e; text-align: center;">selecciona un contacto para chatear</p>
          </div>
          
          <!-- FORMULARIO DE MENSAJE -->
          <div style="display: flex; gap: 12px;" id="chatFormContainer">
            <input type="text" id="chatMessageInput" class="input" placeholder="escribe tu mensaje..." style="flex: 1;">
            <button class="btn btn-primary" id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
      
      <!-- COLUMNA DERECHA: FEED + DIARIO + JUEGOS -->
      <div>
        <!-- FEED SOCIAL P√öBLICO -->
        <div class="glass-card" style="margin-bottom: 25px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span style="font-size: 2rem;">üì∞</span>
            <h3>feed de pensamientos</h3>
          </div>
          
          <!-- PUBLICAR EN FEED -->
          <div style="margin-bottom: 25px;">
            <textarea id="feedPostInput" class="input" placeholder="comparte algo con todos..." rows="2" style="border-radius: 30px; margin-bottom: 12px;"></textarea>
            <div style="display: flex; justify-content: flex-end;">
              <button class="btn btn-primary" id="publishFeedBtn"><i class="fas fa-feather"></i> publicar</button>
            </div>
          </div>
          
          <!-- LISTA DE POSTS -->
          <div id="feedPostsContainer" style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
            <p style="color: #a8767e; text-align: center;">cargando pensamientos...</p>
          </div>
        </div>
        
        <!-- MODO SOLITARIO: DIARIO PRIVADO -->
        <div class="glass-card" style="margin-bottom: 25px; background: #fff9f0;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span style="font-size: 2rem;">üåô</span>
            <h3>modo solitario ¬∑ diario √≠ntimo</h3>
            <span class="badge" style="background: #ffb6c1; color: white;">solo t√∫</span>
          </div>
          
          <div style="margin-bottom: 20px;">
            <textarea id="diarioEntryInput" class="input" placeholder="escribe lo que sientes, solo t√∫ lo ver√°s..." rows="2" style="border-radius: 30px; margin-bottom: 12px;"></textarea>
            <div style="display: flex; justify-content: flex-end;">
              <button class="btn btn-success" id="saveDiarioBtn"><i class="fas fa-save"></i> guardar en mi diario</button>
            </div>
          </div>
          
          <div id="diarioEntriesContainer" style="max-height: 300px; overflow-y: auto;">
            <!-- Se llena con JS -->
          </div>
        </div>
        
        <!-- JUEGOS Y RECOMPENSAS -->
        <div class="glass-card">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
            <span style="font-size: 2rem;">üéÆ</span>
            <h3>juegos ¬∑ recompensa diaria</h3>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <!-- JUEGO 1: Reflejos -->
            <div class="game-card">
              <span style="font-size: 2rem;">‚ö°</span>
              <h4 style="margin: 12px 0;">prueba de reflejos</h4>
              <div id="miniReactionBox" class="reaction-box" style="padding: 20px; font-size: 1.5rem; margin-bottom: 12px;">
                üíñ toca
              </div>
              <button class="btn btn-outline" id="miniReactionBtn" style="width: 100%;">jugar</button>
              <p style="margin-top: 10px; font-size: 0.8rem;">mejor: <span id="miniBestTime">-</span> ms</p>
            </div>
            
            <!-- JUEGO 2: Recompensa diaria -->
            <div class="game-card">
              <span style="font-size: 2rem;">üéÅ</span>
              <h4 style="margin: 12px 0;">recompensa diaria</h4>
              <div style="background: white; border-radius: 30px; padding: 15px; margin-bottom: 12px;">
                <span style="font-size: 1.5rem; display: block;" id="dailyRewardEmoji">üå∏</span>
                <span id="dailyRewardMessage">¬°vuelve ma√±ana!</span>
              </div>
              <button class="btn btn-success" id="claimDailyRewardBtn" style="width: 100%;">reclamar</button>
            </div>
          </div>
          
          <!-- COLECCIONABLES -->
          <div style="margin-top: 20px; padding-top: 20px; border-top: 3px dashed #ffced7;">
            <p style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
              <i class="fas fa-star" style="color: #ffb800;"></i> tus coleccionables
            </p>
            <div id="collectiblesContainer" style="display: flex; gap: 12px; flex-wrap: wrap;">
              <!-- Se llena con JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ===== FOOTER ===== -->
  <div style="margin-top: 40px; text-align: center; color: #a8767e; border-top: 3px dashed #ffced7; padding-top: 25px;">
    <p style="font-size: 1.1rem;">‚ú® red social emocional ¬∑ creada para marleys con infinito cari√±o ‚ú®</p>
    <p style="margin-top: 8px;" id="globalFooterStatus">üåô modo solitario disponible</p>
  </div>

</div>

<!-- ===== MODAL DIARIO (VISTA COMPLETA) ===== -->
<div id="diarioModal" style="display: none; position: fixed; inset: 0; background: rgba(100, 60, 70, 0.3); backdrop-filter: blur(12px); align-items: center; justify-content: center; z-index: 9998;">
  <div style="background: white; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border-radius: 60px; padding: 35px; border: 8px solid white;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px;">
      <h2 style="font-size: 2rem; color: #b54a5a;">üìî mi diario</h2>
      <button class="btn" id="closeDiarioModalBtn" style="background: #ffe2ec;">cerrar</button>
    </div>
    <div id="diarioFullEntries">
      <!-- se llena con JS -->
    </div>
  </div>
</div>

<script type="module">
  // ========== FIREBASE ==========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, update, get, onDisconnect, query, orderByChild, equalTo, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyByB_5gP3sDwbCmVWbiB5CQXHzsKhcDvoo",
    authDomain: "chist-4aac2.firebaseapp.com",
    databaseURL: "https://chist-4aac2-default-rtdb.firebaseio.com",
    projectId: "chist-4aac2",
    storageBucket: "chist-4aac2.firebasestorage.app",
    messagingSenderId: "64011595640",
    appId: "1:64011595640:web:8fa8b005b916cf2af7628d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  console.log("üî• FIREBASE LISTO");

  // ========== ESTADO GLOBAL ==========
  let currentUser = {
    id: null,
    alias: null,
    isLoggedIn: false,
    mood: 'feliz',
    dailyRewardClaimed: false,
    lastRewardDate: null,
    collectibles: []
  };

  // ========== UTILIDADES ==========
  function showNotification(msg, type = 'happy') {
    const notif = document.createElement('div');
    notif.className = 'notification';
    notif.innerHTML = `<i class="fas fa-heart"></i> ${msg}`;
    if (type === 'success') notif.style.background = '#7ac9a0';
    if (type === 'reward') notif.style.background = '#ffb800';
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
  }

  function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
  }

  // ========== AUTENTICACI√ìN ==========
  async function register(alias) {
    if (!alias || alias.trim().length < 2) {
      showNotification('elige un alias bonito');
      return;
    }
    
    const cleanAlias = alias.trim();
    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2);
    
    currentUser = {
      id: userId,
      alias: cleanAlias,
      isLoggedIn: true,
      mood: 'feliz',
      dailyRewardClaimed: false,
      collectibles: []
    };
    
    localStorage.setItem('marleysSocialUser', JSON.stringify({
      id: userId,
      alias: cleanAlias
    }));
    
    try {
      await set(ref(db, `users/${userId}`), {
        id: userId,
        alias: cleanAlias,
        online: true,
        mood: 'feliz',
        registeredAt: Date.now(),
        lastActive: Date.now()
      });
      
      onDisconnect(ref(db, `users/${userId}`)).update({
        online: false,
        lastActive: Date.now()
      });
      
      // Inicializar diario privado
      await set(ref(db, `diario/${userId}`), {});
      
      // Inicializar coleccionables
      await set(ref(db, `collectibles/${userId}`), {
        flowers: 1,
        stars: 0,
        hearts: 0
      });
      
      currentUser.collectibles = { flowers: 1, stars: 0, hearts: 0 };
      
      updateUI();
      showNotification(`‚ú® bienvenida, ${cleanAlias}`);
      
    } catch (error) {
      console.error(error);
      showNotification('error de conexi√≥n');
    }
  }

  async function logout() {
    if (currentUser.isLoggedIn) {
      await update(ref(db, `users/${currentUser.id}`), { online: false, lastActive: Date.now() });
    }
    localStorage.removeItem('marleysSocialUser');
    currentUser = { id: null, alias: null, isLoggedIn: false };
    updateUI();
    showNotification('üåô sesi√≥n cerrada');
  }

  // ========== UI ==========
  function updateUI() {
    const notLogged = document.getElementById('notLoggedView');
    const logged = document.getElementById('loggedView');
    const mainContent = document.getElementById('mainAppContent');
    const footer = document.getElementById('globalFooterStatus');
    
    if (currentUser.isLoggedIn) {
      notLogged.style.display = 'none';
      logged.style.display = 'block';
      mainContent.style.display = 'block';
      document.getElementById('userNameDisplay').innerText = currentUser.alias;
      document.getElementById('userAvatar').innerHTML = currentUser.alias.substring(0,2).toUpperCase();
      document.getElementById('userMoodBadge').innerHTML = `<i class="fas fa-smile"></i> ${currentUser.mood}`;
      footer.innerHTML = `üå∏ conectada como ${currentUser.alias} ¬∑ modo solitario disponible`;
      
      // Cargar datos del usuario
      loadUsers();
      loadPendingRequests();
      loadFeedPosts();
      loadDiarioEntries();
      loadCollectibles();
      checkDailyReward();
      
    } else {
      notLogged.style.display = 'block';
      logged.style.display = 'none';
      mainContent.style.display = 'none';
      footer.innerHTML = 'üåô modo solitario disponible';
    }
  }

  // ========== 1. M√ìDULO DE USUARIOS ==========
  function loadUsers() {
    onValue(ref(db, 'users'), (snapshot) => {
      if (!snapshot.exists()) return;
      
      const users = snapshot.val();
      const onlineCount = Object.values(users).filter(u => u.online).length;
      document.getElementById('onlineCount').innerText = onlineCount;
      
      // Lista de usuarios para conectar
      const searchTerm = document.getElementById('userSearchInput')?.value?.toLowerCase() || '';
      let html = '';
      
      Object.entries(users).forEach(([id, user]) => {
        if (id === currentUser.id) return; // no mostrarse a s√≠ mismo
        
        const alias = user.alias || 'usuario';
        if (searchTerm && !alias.toLowerCase().includes(searchTerm)) return;
        
        html += `
          <div class="user-card">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div class="avatar avatar-sm" style="background: linear-gradient(145deg, #ffb8c9, #ff90a5);">
                ${alias.substring(0,2).toUpperCase()}
              </div>
              <div>
                <div style="font-weight: 700;">${alias}</div>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                  <span class="badge ${user.online ? 'badge-online' : ''}" style="${!user.online ? 'background: #e2e2e2;' : ''}">
                    <i class="fas fa-circle" style="font-size: 0.6rem;"></i> ${user.online ? 'conectada' : 'desconectada'}
                  </span>
                  <span class="badge"><i class="fas fa-smile"></i> ${user.mood || 'feliz'}</span>
                </div>
              </div>
            </div>
            <button class="btn btn-outline send-request-btn" data-userid="${id}" data-alias="${alias}" style="padding: 10px 20px;">
              <i class="fas fa-user-plus"></i>
            </button>
          </div>
        `;
      });
      
      document.getElementById('usersListContainer').innerHTML = html || '<p style="color: #a8767e; text-align: center;">no hay usuarios</p>';
      
      // Event listeners para enviar solicitudes
      document.querySelectorAll('.send-request-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          sendFriendRequest(btn.dataset.userid, btn.dataset.alias);
        });
      });
    });
  }

  // ========== 2. SISTEMA DE CONEXIONES ==========
  async function sendFriendRequest(toUserId, toAlias) {
    if (!currentUser.isLoggedIn) return;
    
    const requestId = `${currentUser.id}_${toUserId}`;
    const requestRef = ref(db, `friendRequests/${requestId}`);
    
    // Verificar si ya existe
    const snapshot = await get(requestRef);
    if (snapshot.exists()) {
      showNotification('solicitud ya enviada');
      return;
    }
    
    await set(requestRef, {
      from: currentUser.id,
      fromAlias: currentUser.alias,
      to: toUserId,
      toAlias: toAlias,
      status: 'pending',
      timestamp: Date.now()
    });
    
    showNotification(`solicitud enviada a ${toAlias}`);
  }

  async function loadPendingRequests() {
    if (!currentUser.isLoggedIn) return;
    
    const requestsRef = ref(db, 'friendRequests');
    const snapshot = await get(requestsRef);
    
    if (!snapshot.exists()) {
      document.getElementById('pendingRequestsContainer').innerHTML = '<p style="color: #a8767e; text-align: center;">no hay solicitudes</p>';
      document.getElementById('pendingRequestsBadge').innerText = '0';
      return;
    }
    
    const requests = snapshot.val();
    const pendingToMe = Object.entries(requests)
      .filter(([id, req]) => req.to === currentUser.id && req.status === 'pending')
      .map(([id, req]) => req);
    
    document.getElementById('pendingRequestsBadge').innerText = pendingToMe.length;
    
    if (pendingToMe.length === 0) {
      document.getElementById('pendingRequestsContainer').innerHTML = '<p style="color: #a8767e; text-align: center;">no hay solicitudes</p>';
      return;
    }
    
    let html = '';
    pendingToMe.forEach(req => {
      html += `
        <div class="user-card" style="margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 15px;">
            <div class="avatar avatar-sm">${req.fromAlias.substring(0,2).toUpperCase()}</div>
            <div>
              <div style="font-weight: 700;">${req.fromAlias}</div>
              <div style="font-size: 0.8rem;">quiere conectarse</div>
            </div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-success accept-request-btn" data-from="${req.from}" style="padding: 8px 16px;">aceptar</button>
            <button class="btn reject-request-btn" data-from="${req.from}" style="background: #ffe2ec; padding: 8px 16px;">rechazar</button>
          </div>
        </div>
      `;
    });
    
    document.getElementById('pendingRequestsContainer').innerHTML = html;
    
    // Event listeners
    document.querySelectorAll('.accept-request-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const fromUserId = btn.dataset.from;
        await acceptFriendRequest(fromUserId);
      });
    });
    
    document.querySelectorAll('.reject-request-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const fromUserId = btn.dataset.from;
        await rejectFriendRequest(fromUserId);
      });
    });
  }

  async function acceptFriendRequest(fromUserId) {
    const requestId = `${fromUserId}_${currentUser.id}`;
    
    // Crear conexi√≥n bidireccional
    await set(ref(db, `connections/${currentUser.id}/${fromUserId}`), {
      userId: fromUserId,
      connectedAt: Date.now()
    });
    
    await set(ref(db, `connections/${fromUserId}/${currentUser.id}`), {
      userId: currentUser.id,
      connectedAt: Date.now()
    });
    
    // Eliminar solicitud
    await remove(ref(db, `friendRequests/${requestId}`));
    
    showNotification('solicitud aceptada üíï');
    loadPendingRequests();
    loadChatContacts();
  }

  async function rejectFriendRequest(fromUserId) {
    const requestId = `${fromUserId}_${currentUser.id}`;
    await remove(ref(db, `friendRequests/${requestId}`));
    showNotification('solicitud rechazada');
    loadPendingRequests();
  }

  async function loadConnections() {
    if (!currentUser.isLoggedIn) return [];
    
    const snapshot = await get(ref(db, `connections/${currentUser.id}`));
    if (!snapshot.exists()) return [];
    
    return Object.keys(snapshot.val());
  }

  // ========== 3. CHAT PRIVADO ==========
  async function loadChatContacts() {
    if (!currentUser.isLoggedIn) return;
    
    const connections = await loadConnections();
    const select = document.getElementById('chatUserSelect');
    
    let options = '<option value="">selecciona un contacto</option>';
    
    for (const userId of connections) {
      const userSnapshot = await get(ref(db, `users/${userId}`));
      if (userSnapshot.exists()) {
        const user = userSnapshot.val();
        options += `<option value="${userId}">üí¨ ${user.alias}</option>`;
      }
    }
    
    select.innerHTML = options;
  }

  function loadChatMessages(otherUserId) {
    if (!otherUserId) {
      document.getElementById('chatMessagesContainer').innerHTML = '<p style="color: #a8767e; text-align: center;">selecciona un contacto</p>';
      return;
    }
    
    const chatId = [currentUser.id, otherUserId].sort().join('_');
    const messagesRef = ref(db, `chats/${chatId}`);
    
    onValue(messagesRef, (snapshot) => {
      const messages = snapshot.val();
      const container = document.getElementById('chatMessagesContainer');
      
      if (!messages) {
        container.innerHTML = '<p style="color: #a8767e; text-align: center;">no hay mensajes a√∫n</p>';
        return;
      }
      
      const messagesArray = Object.entries(messages)
        .sort((a,b) => a[1].timestamp - b[1].timestamp)
        .map(([id, msg]) => msg);
      
      let html = '';
      messagesArray.forEach(msg => {
        const isMine = msg.from === currentUser.id;
        html += `
          <div style="display: flex; flex-direction: column; ${isMine ? 'align-items: flex-end;' : 'align-items: flex-start;'}">
            <div class="${isMine ? 'chat-bubble-mine' : 'chat-bubble-other'}">
              <div style="font-size: 0.75rem; margin-bottom: 5px; ${isMine ? 'color: rgba(255,255,255,0.9);' : 'color: #a8767e;'}">
                ${isMine ? 't√∫' : msg.fromAlias} ¬∑ ${formatTime(msg.timestamp)}
              </div>
              <div style="font-size: 1rem;">${msg.text}</div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      container.scrollTop = container.scrollHeight;
    });
  }

  async function sendMessage() {
    if (!currentUser.isLoggedIn) return;
    
    const otherUserId = document.getElementById('chatUserSelect').value;
    if (!otherUserId) {
      showNotification('selecciona un contacto');
      return;
    }
    
    const text = document.getElementById('chatMessageInput').value.trim();
    if (!text) return;
    
    const chatId = [currentUser.id, otherUserId].sort().join('_');
    const messageRef = push(ref(db, `chats/${chatId}`));
    
    await set(messageRef, {
      from: currentUser.id,
      fromAlias: currentUser.alias,
      to: otherUserId,
      text: text,
      timestamp: Date.now()
    });
    
    document.getElementById('chatMessageInput').value = '';
  }

  // ========== 4. FEED SOCIAL ==========
  async function publishFeedPost() {
    if (!currentUser.isLoggedIn) return;
    
    const text = document.getElementById('feedPostInput').value.trim();
    if (!text) return;
    
    const postRef = push(ref(db, 'feed'));
    await set(postRef, {
      alias: currentUser.alias,
      userId: currentUser.id,
      text: text,
      timestamp: Date.now(),
      likes: 0,
      likedBy: {}
    });
    
    document.getElementById('feedPostInput').value = '';
    showNotification('pensamiento publicado ‚ú®');
  }

  function loadFeedPosts() {
    const feedRef = ref(db, 'feed');
    
    onValue(feedRef, (snapshot) => {
      if (!snapshot.exists()) {
        document.getElementById('feedPostsContainer').innerHTML = '<p style="color: #a8767e; text-align: center;">a√∫n no hay pensamientos</p>';
        return;
      }
      
      const posts = Object.entries(snapshot.val())
        .sort((a,b) => b[1].timestamp - a[1].timestamp)
        .slice(0, 10);
      
      let html = '';
      posts.forEach(([id, post]) => {
        const userLiked = post.likedBy && post.likedBy[currentUser.id];
        
        html += `
          <div style="background: white; border-radius: 30px; padding: 22px; margin-bottom: 18px; border: 3px solid #ffe2ec;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div class="avatar avatar-sm">${post.alias.substring(0,2).toUpperCase()}</div>
              <div>
                <span style="font-weight: 700;">${post.alias}</span>
                <span style="display: block; font-size: 0.7rem; color: #a8767e;">${new Date(post.timestamp).toLocaleString()}</span>
              </div>
            </div>
            <p style="margin: 12px 0 16px 8px; font-size: 1.1rem;">${post.text}</p>
            <div style="display: flex; align-items: center; gap: 15px;">
              <button class="btn like-btn" data-postid="${id}" style="background: ${userLiked ? '#ff7a8f' : '#ffe2ec'}; color: ${userLiked ? 'white' : '#4a3035'}; padding: 8px 20px;">
                <i class="fas fa-heart"></i> ${post.likes || 0}
              </button>
            </div>
          </div>
        `;
      });
      
      document.getElementById('feedPostsContainer').innerHTML = html;
      
      // Like functionality
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const postId = btn.dataset.postid;
          await likePost(postId);
        });
      });
    });
  }

  async function likePost(postId) {
    if (!currentUser.isLoggedIn) return;
    
    const postRef = ref(db, `feed/${postId}`);
    const snapshot = await get(postRef);
    
    if (snapshot.exists()) {
      const post = snapshot.val();
      const likedBy = post.likedBy || {};
      
      if (likedBy[currentUser.id]) {
        // Unlike
        delete likedBy[currentUser.id];
        await update(postRef, {
          likes: (post.likes || 0) - 1,
          likedBy: likedBy
        });
      } else {
        // Like
        likedBy[currentUser.id] = true;
        await update(postRef, {
          likes: (post.likes || 0) + 1,
          likedBy: likedBy
        });
      }
    }
  }

  // ========== 5. MODO SOLITARIO - DIARIO PRIVADO ==========
  async function saveDiarioEntry() {
    if (!currentUser.isLoggedIn) return;
    
    const text = document.getElementById('diarioEntryInput').value.trim();
    if (!text) return;
    
    const entryRef = push(ref(db, `diario/${currentUser.id}`));
    await set(entryRef, {
      text: text,
      timestamp: Date.now()
    });
    
    document.getElementById('diarioEntryInput').value = '';
    showNotification('guardado en tu diario üìî');
    loadDiarioEntries();
  }

  async function loadDiarioEntries() {
    if (!currentUser.isLoggedIn) return;
    
    const snapshot = await get(ref(db, `diario/${currentUser.id}`));
    
    if (!snapshot.exists()) {
      document.getElementById('diarioEntriesContainer').innerHTML = '<p style="color: #a8767e; text-align: center;">a√∫n no hay entradas en tu diario</p>';
      document.getElementById('diarioFullEntries').innerHTML = '<p style="color: #a8767e; text-align: center;">a√∫n no hay entradas</p>';
      return;
    }
    
    const entries = Object.entries(snapshot.val())
      .sort((a,b) => b[1].timestamp - a[1].timestamp)
      .slice(0, 5);
    
    let html = '';
    let fullHtml = '';
    
    entries.forEach(([id, entry]) => {
      const date = new Date(entry.timestamp).toLocaleString();
      html += `
        <div class="diario-entry">
          <p style="font-size: 0.8rem; color: #a8767e; margin-bottom: 8px;">üìÖ ${date}</p>
          <p>${entry.text}</p>
        </div>
      `;
      
      fullHtml += `
        <div class="diario-entry" style="margin-bottom: 20px;">
          <p style="font-size: 0.8rem; color: #a8767e; margin-bottom: 8px;">üìÖ ${date}</p>
          <p style="font-size: 1.1rem;">${entry.text}</p>
        </div>
      `;
    });
    
    document.getElementById('diarioEntriesContainer').innerHTML = html || '<p style="color: #a8767e;">no hay entradas</p>';
    document.getElementById('diarioFullEntries').innerHTML = fullHtml || '<p style="color: #a8767e;">no hay entradas</p>';
  }

  // ========== 6. JUEGOS Y RECOMPENSAS ==========
  // Juego de reflejos
  let reactionActive = false;
  let reactionStartTime = null;
  let bestTime = localStorage.getItem('marleysBestReaction') || null;
  
  if (bestTime) document.getElementById('miniBestTime').innerText = bestTime;

  function startMiniReaction() {
    if (!currentUser.isLoggedIn) {
      showNotification('inicia sesi√≥n para jugar');
      return;
    }
    
    if (reactionActive) return;
    
    reactionActive = true;
    const box = document.getElementById('miniReactionBox');
    const btn = document.getElementById('miniReactionBtn');
    
    box.innerText = 'üå∏ espera...';
    box.style.background = '#ffccd5';
    btn.disabled = true;
    
    setTimeout(() => {
      if (!reactionActive) return;
      
      reactionStartTime = Date.now();
      box.innerText = 'üí• TOCA!';
      box.style.background = '#ffa5b6';
      box.style.cursor = 'pointer';
      
      box.onclick = () => {
        const time = Date.now() - reactionStartTime;
        reactionActive = false;
        box.innerText = `‚ö° ${time} ms`;
        box.onclick = null;
        btn.disabled = false;
        
        if (!bestTime || time < parseInt(bestTime)) {
          bestTime = time;
          localStorage.setItem('marleysBestReaction', time);
          document.getElementById('miniBestTime').innerText = time;
          
          // Recompensa por r√©cord
          addCollectible('‚ö°', 'r√©cord reflejos');
          showNotification('üèÜ nuevo r√©cord! +‚ö°', 'reward');
        }
      };
    }, Math.random() * 2000 + 1500);
  }

  // Recompensa diaria
  async function checkDailyReward() {
    if (!currentUser.isLoggedIn) return;
    
    const lastClaim = localStorage.getItem('marleysLastReward');
    const today = new Date().toDateString();
    
    if (lastClaim === today) {
      document.getElementById('dailyRewardEmoji').innerText = '‚úÖ';
      document.getElementById('dailyRewardMessage').innerText = 'ya reclamaste hoy';
      document.getElementById('claimDailyRewardBtn').disabled = true;
    } else {
      document.getElementById('dailyRewardEmoji').innerText = 'üéÅ';
      document.getElementById('dailyRewardMessage').innerText = '¬°reclama tu recompensa!';
      document.getElementById('claimDailyRewardBtn').disabled = false;
    }
  }

  async function claimDailyReward() {
    if (!currentUser.isLoggedIn) return;
    
    const today = new Date().toDateString();
    localStorage.setItem('marleysLastReward', today);
    
    // Dar coleccionable aleatorio
    const rewards = ['üå∏', '‚ú®', 'üíñ', 'ü¶ã', 'üåü'];
    const reward = rewards[Math.floor(Math.random() * rewards.length)];
    
    await addCollectible(reward, 'recompensa diaria');
    
    document.getElementById('dailyRewardEmoji').innerText = '‚úÖ';
    document.getElementById('dailyRewardMessage').innerText = '¬°reclamada!';
    document.getElementById('claimDailyRewardBtn').disabled = true;
    
    showNotification(`üéÅ reclamaste: ${reward}`, 'reward');
  }

  // Coleccionables
  async function loadCollectibles() {
    if (!currentUser.isLoggedIn) return;
    
    const snapshot = await get(ref(db, `collectibles/${currentUser.id}`));
    
    if (!snapshot.exists()) {
      document.getElementById('collectiblesContainer').innerHTML = '<span class="badge">üå∏ 1</span>';
      return;
    }
    
    const cols = snapshot.val();
    let html = '';
    
    if (cols.flowers) html += `<span class="badge" style="background: #ffe2ec;">üå∏ ${cols.flowers}</span>`;
    if (cols.stars) html += `<span class="badge" style="background: #fff1c1;">‚ú® ${cols.stars}</span>`;
    if (cols.hearts) html += `<span class="badge" style="background: #ffd6e0;">üíñ ${cols.hearts}</span>`;
    if (cols.lightning) html += `<span class="badge" style="background: #ffe0b5;">‚ö° ${cols.lightning}</span>`;
    
    document.getElementById('collectiblesContainer').innerHTML = html || '<span class="badge">üå∏ 1</span>';
  }

  async function addCollectible(type, reason) {
    if (!currentUser.isLoggedIn) return;
    
    const collectibleRef = ref(db, `collectibles/${currentUser.id}`);
    const snapshot = await get(collectibleRef);
    
    let collectibles = snapshot.exists() ? snapshot.val() : { flowers: 1, stars: 0, hearts: 0 };
    
    if (type === 'üå∏') collectibles.flowers = (collectibles.flowers || 0) + 1;
    if (type === '‚ú®') collectibles.stars = (collectibles.stars || 0) + 1;
    if (type === 'üíñ') collectibles.hearts = (collectibles.hearts || 0) + 1;
    if (type === '‚ö°') collectibles.lightning = (collectibles.lightning || 0) + 1;
    
    await set(collectibleRef, collectibles);
    loadCollectibles();
  }

  // ========== 7. CAMBIAR ESTADO EMOCIONAL ==========
  async function setMood(mood) {
    if (!currentUser.isLoggedIn) return;
    
    currentUser.mood = mood;
    await update(ref(db, `users/${currentUser.id}`), { mood: mood });
    
    const moodNames = { feliz: 'üòä feliz', tranquila: 'üòå tranquila', nostalgica: 'ü•∫ nost√°lgica', energetica: '‚ö° energ√©tica' };
    document.getElementById('userMoodBadge').innerHTML = `<i class="fas fa-smile"></i> ${moodNames[mood]}`;
    showNotification(`estado actualizado: ${moodNames[mood]}`);
  }

  // ========== 8. EVENT LISTENERS ==========
  function setupEventListeners() {
    // Registro
    document.getElementById('registerBtn').addEventListener('click', () => {
      register(document.getElementById('registerAliasInput').value);
    });
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    // B√∫squeda de usuarios
    document.getElementById('userSearchInput')?.addEventListener('input', loadUsers);
    
    // Chat
    document.getElementById('chatUserSelect').addEventListener('change', (e) => {
      loadChatMessages(e.target.value);
    });
    
    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    
    document.getElementById('chatMessageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    // Feed
    document.getElementById('publishFeedBtn').addEventListener('click', publishFeedPost);
    
    // Diario
    document.getElementById('saveDiarioBtn').addEventListener('click', saveDiarioEntry);
    
    document.getElementById('openDiarioBtn').addEventListener('click', () => {
      document.getElementById('diarioModal').style.display = 'flex';
      loadDiarioEntries();
    });
    
    document.getElementById('closeDiarioModalBtn').addEventListener('click', () => {
      document.getElementById('diarioModal').style.display = 'none';
    });
    
    // Juegos
    document.getElementById('miniReactionBtn').addEventListener('click', startMiniReaction);
    document.getElementById('claimDailyRewardBtn').addEventListener('click', claimDailyReward);
    
    // Estados de √°nimo
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        setMood(btn.dataset.mood);
      });
    });
    
    // Cerrar modal al hacer click fuera
    document.getElementById('diarioModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('diarioModal')) {
        document.getElementById('diarioModal').style.display = 'none';
      }
    });
  }

  // ========== INICIALIZACI√ìN ==========
  async function init() {
    console.log("üå∏ Iniciando Marleys Social...");
    
    // Cargar usuario guardado
    const saved = localStorage.getItem('marleysSocialUser');
    if (saved) {
      try {
        const u = JSON.parse(saved);
        if (u && u.id && u.alias) {
          currentUser = {
            id: u.id,
            alias: u.alias,
            isLoggedIn: true,
            mood: 'feliz'
          };
          
          await set(ref(db, `users/${u.id}`), {
            id: u.id,
            alias: u.alias,
            online: true,
            mood: 'feliz',
            lastActive: Date.now()
          });
          
          onDisconnect(ref(db, `users/${u.id}`)).update({
            online: false,
            lastActive: Date.now()
          });
        }
      } catch (e) {
        console.error(e);
      }
    }
    
    updateUI();
    setupEventListeners();
    
    if (currentUser.isLoggedIn) {
      loadChatContacts();
    }
  }

  init();

</script>

</body>
</html>