<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visor Forense de Imágenes</title>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      background: #0f2027; 
      background: linear-gradient(to right, #2c5364, #203a43, #0f2027);
      color: #fff;
    }
    header {
      padding: 1em; text-align: center;
      background: rgba(0,0,0,0.4); backdrop-filter: blur(6px);
    }
    h1 { margin: 0; }
    #drop-area {
      border: 2px dashed #aaa;
      border-radius: 10px;
      margin: 20px auto; width: 80%; max-width: 600px;
      padding: 30px; text-align: center;
      transition: 0.3s;
      background: rgba(255,255,255,0.1);
    }
    #drop-area.highlight { border-color: #00ffcc; }
    #gallery { margin: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
    .thumb { width: 150px; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer; }
    #metadata { background: rgba(255,255,255,0.1); margin: 20px; padding: 10px; border-radius: 8px; }
    #map { height: 400px; margin: 20px; border-radius: 8px; }
    .controls { margin: 20px; }
    button {
      margin: 5px; padding: 10px 15px;
      border: none; border-radius: 6px;
      background: #00ffcc; color: #000;
      cursor: pointer; transition: 0.2s;
    }
    button:hover { background: #00ccaa; }
    .toast {
      position: fixed; top: 20px; right: 20px;
      background: #333; color: #fff;
      padding: 10px 15px; border-radius: 6px;
      opacity: 0; pointer-events: none; transition: opacity 0.5s;
    }
    .toast.show { opacity: 1; pointer-events: auto; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
</head>
<body>
  <header>
    <h1>🔍 Visor Forense de Metadatos</h1>
  </header>

  <div id="drop-area">
    <p>Arrastra y suelta imágenes<br>o haz clic para seleccionar</p>
    <input type="file" id="fileElem" multiple accept="image/*" style="display:none">
    <button onclick="document.getElementById('fileElem').click()">Seleccionar imágenes</button>
  </div>

  <div id="gallery"></div>
  <div id="metadata"><h3>Metadatos</h3><pre id="metaContent">Seleccione una imagen</pre></div>

  <div id="map"></div>

  <div class="controls">
    <button id="stripBtn">🧹 Eliminar EXIF</button>
    <button id="calcHashBtn">🔑 Calcular SHA-256</button>
    <button id="exportCsvBtn">📑 Exportar CSV</button>
    <button id="exportJsonBtn">📑 Exportar JSON</button>
    <button id="exportZipBtn">📦 Exportar ZIP</button>
    <button id="btnShowAll">🌍 Mostrar todo</button>
    <button id="fitAllBtn">📍 Ajustar al mapa</button>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    const dropArea = document.getElementById('drop-area');
    const gallery = document.getElementById('gallery');
    const metaContent = document.getElementById('metaContent');
    const toast = document.getElementById('toast');
    let imagesData = [];
    let map = L.map('map').setView([0,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    let markers = L.markerClusterGroup().addTo(map);
    let selectedImage = null;

    // ---- Drag & Drop ----
    ;['dragenter','dragover'].forEach(eventName=>{
      dropArea.addEventListener(eventName, e=>{
        e.preventDefault(); e.stopPropagation(); dropArea.classList.add('highlight');
      });
    });
    ;['dragleave','drop'].forEach(eventName=>{
      dropArea.addEventListener(eventName, e=>{
        e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('highlight');
      });
    });
    dropArea.addEventListener('drop', e=>{
      let dt = e.dataTransfer; handleFiles(dt.files);
    });
    document.getElementById('fileElem').addEventListener('change', e=>handleFiles(e.target.files));

    // ---- Procesar archivos ----
    async function handleFiles(files){
      for(let file of files){
        if(!file.type.startsWith('image/')) continue;
        let imgURL = URL.createObjectURL(file);
        let img = document.createElement('img');
        img.src = imgURL; img.className='thumb';
        img.onclick = ()=>showMetadata(file,imgURL);
        gallery.appendChild(img);

        try {
          let meta = await exifr.parse(file,{iptc:true,xmp:true,icc:true});
          imagesData.push({file,meta,imgURL});
          if(meta && meta.latitude && meta.longitude){
            let marker = L.marker([meta.latitude, meta.longitude]);
            marker.bindPopup(`<img src="${imgURL}" width="100"><br>${file.name}`);
            markers.addLayer(marker);
          }
        } catch(err){
          console.warn("No se pudo leer metadatos",err);
        }
      }
      map.addLayer(markers);
    }

    function showMetadata(file,imgURL){
      selectedImage = {file,imgURL};
      let data = imagesData.find(d=>d.file===file);
      if(!data || !data.meta){ 
        metaContent.textContent="⚠️ No se encontraron metadatos."; 
        showToast("Imagen sin EXIF","warn"); return;
      }
      metaContent.textContent = JSON.stringify(data.meta,null,2);
    }

    function showToast(msg,type="info"){
      toast.textContent=msg;
      toast.style.background = type==="warn"?"#e67e22": type==="error"?"#c0392b":"#333";
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),3000);
    }

    // ---- Botones ----
    document.getElementById('stripBtn').addEventListener('click', async ()=>{
      if(!selectedImage){ showToast("Selecciona una imagen","warn"); return; }
      let img = new Image();
      img.src = selectedImage.imgURL;
      await img.decode();
      let canvas = document.createElement('canvas');
      canvas.width = img.width; canvas.height = img.height;
      canvas.getContext('2d').drawImage(img,0,0);
      canvas.toBlob(blob=>{
        let a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download="clean-"+selectedImage.file.name;
        a.click();
        showToast("EXIF eliminado y nueva imagen descargada","success");
      },'image/jpeg',0.95);
    });

    document.getElementById('calcHashBtn').addEventListener('click', async ()=>{
      if(!selectedImage){ showToast("Selecciona una imagen","warn"); return; }
      let buf = await selectedImage.file.arrayBuffer();
      let hashBuf = await crypto.subtle.digest('SHA-256',buf);
      let hashArr = Array.from(new Uint8Array(hashBuf));
      let hashHex = hashArr.map(b=>b.toString(16).padStart(2,'0')).join('');
      showToast("SHA-256: "+hashHex,"info");
      console.log("SHA-256:",hashHex);
    });

    document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
      if(imagesData.length===0){ showToast("No hay datos","warn"); return; }
      let rows=["file,latitude,longitude,DateTimeOriginal"];
      for(let d of imagesData){
        let m=d.meta||{};
        rows.push(`${d.file.name},${m.latitude||""},${m.longitude||""},${m.DateTimeOriginal||""}`);
      }
      let blob=new Blob([rows.join("\n")],{type:"text/csv"});
      let a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download="metadata.csv"; a.click();
      showToast("Exportado CSV","success");
    });

    document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
      let blob=new Blob([JSON.stringify(imagesData.map(d=>({file:d.file.name,meta:d.meta})),null,2)],{type:"application/json"});
      let a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download="metadata.json"; a.click();
      showToast("Exportado JSON","success");
    });

    document.getElementById('exportZipBtn').addEventListener('click', async ()=>{
      if(imagesData.length===0){ showToast("No hay datos","warn"); return; }
      // Librería externa sería mejor (JSZip), pero aquí generamos JSON+CSV en un solo blob
      let csv="file,latitude,longitude\n"+imagesData.map(d=>`${d.file.name},${d.meta?.latitude||""},${d.meta?.longitude||""}`).join("\n");
      let json=JSON.stringify(imagesData.map(d=>({file:d.file.name,meta:d.meta})),null,2);
      let blob=new Blob([csv+"\n\n---\n\n"+json],{type:"text/plain"});
      let a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download="metadata_pack.txt"; a.click();
      showToast("Exportado ZIP (simulado en txt)","success");
    });

    document.getElementById('btnShowAll').addEventListener('click', ()=>{
      markers.eachLayer(m=>m.openPopup());
    });
    document.getElementById('fitAllBtn').addEventListener('click', ()=>{
      if(markers.getLayers().length>0) map.fitBounds(markers.getBounds());
    });
  </script>
</body>
</html>