<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Peri√≥dico Guacari - Lo Que Pasa Aqu√≠ Se Queda Aqu√≠</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* Variables y estilos base */
  :root {
    --primary: #1a5276;
    --secondary: #2e86c1;
    --accent: #3498db;
    --light: #ebf5fb;
    --dark: #154360;
    --text: #2c3e50;
    --text-light: #7f8c8d;
    --success: #27ae60;
    --warning: #f39c12;
    --danger: #e74c3c;
    --paper: #f9f9f9;
    --border: #d5d8dc;
    --reply-bg: #f8f9fa;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Georgia', 'Times New Roman', serif;
    background: #ecf0f1;
    color: var(--text);
    line-height: 1.6;
    background-image: linear-gradient(rgba(236, 240, 241, 0.9), rgba(236, 240, 241, 0.9)), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f9f9f9"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23d5d8dc" stroke-width="0.5"/></svg>');
    min-height: 100vh;
  }
  
  /* Contenedor principal tipo peri√≥dico */
  .newspaper-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    box-shadow: 0 0 30px rgba(0,0,0,0.1);
    border: 1px solid var(--border);
    position: relative;
    min-height: 100vh;
  }
  
  /* Cabecera del peri√≥dico */
  .newspaper-header {
    border-bottom: 4px double var(--dark);
    padding-bottom: 20px;
    margin-bottom: 30px;
    text-align: center;
    position: relative;
  }
  
  .newspaper-title {
    font-family: 'Times New Roman', serif;
    font-size: 3.5rem;
    color: var(--dark);
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 3px;
  }
  
  .newspaper-subtitle {
    font-size: 1.2rem;
    color: var(--text-light);
    font-style: italic;
    margin-top: 5px;
    letter-spacing: 1px;
  }
  
  .newspaper-motto {
    font-size: 1rem;
    color: var(--primary);
    font-weight: bold;
    margin-top: 10px;
    border-top: 2px solid var(--primary);
    border-bottom: 2px solid var(--primary);
    padding: 5px 0;
    display: inline-block;
  }
  
  .newspaper-date {
    position: absolute;
    right: 0;
    top: 10px;
    font-size: 0.9rem;
    color: var(--text-light);
  }
  
  /* Estado de sesi√≥n */
  .session-status {
    position: absolute;
    left: 0;
    top: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }
  
  .status-online {
    background: var(--success);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  .status-offline {
    background: var(--danger);
  }
  
  /* Secci√≥n de sesi√≥n */
  .session-section {
    background: var(--light);
    padding: 25px;
    border-radius: 8px;
    margin-bottom: 30px;
    border-left: 5px solid var(--primary);
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  }
  
  .session-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
  }
  
  .user-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
  }
  
  .user-details h3 {
    margin: 0 0 5px 0;
    color: var(--dark);
  }
  
  .user-details p {
    margin: 0;
    color: var(--text-light);
    font-size: 0.9rem;
  }
  
  .session-form {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .session-form input {
    padding: 10px 15px;
    border: 2px solid var(--border);
    border-radius: 4px;
    font-size: 1rem;
    min-width: 200px;
  }
  
  .session-form input:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  /* Grid de contenido del peri√≥dico */
  .newspaper-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
  }
  
  @media (max-width: 768px) {
    .newspaper-grid {
      grid-template-columns: 1fr;
    }
  }
  
  /* Art√≠culos principales */
  .main-articles {
    grid-column: 1;
  }
  
  /* Sidebar */
  .newspaper-sidebar {
    grid-column: 2;
  }
  
  @media (max-width: 768px) {
    .newspaper-sidebar {
      grid-column: 1;
    }
  }
  
  /* Estilo de art√≠culos */
  .article {
    background: white;
    border: 1px solid var(--border);
    padding: 25px;
    margin-bottom: 25px;
    position: relative;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    transition: transform 0.3s, box-shadow 0.3s;
  }
  
  .article:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  
  .article-header {
    border-bottom: 2px solid var(--primary);
    padding-bottom: 15px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .article-title {
    font-size: 1.8rem;
    color: var(--dark);
    margin: 0;
    font-family: 'Times New Roman', serif;
  }
  
  .article-meta {
    color: var(--text-light);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  /* Secci√≥n de comentarios */
  .comments-section {
    margin-top: 30px;
    border-top: 1px dashed var(--border);
    padding-top: 20px;
  }
  
  .comment-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 25px;
  }
  
  .comment-input {
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 1rem;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
  }
  
  .comment-input:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  .comments-list {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
  }
  
  .comment {
    background: var(--light);
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 4px;
    border-left: 3px solid var(--accent);
    position: relative;
  }
  
  .comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }
  
  .comment-author {
    font-weight: bold;
    color: var(--primary);
  }
  
  .comment-time {
    color: var(--text-light);
  }
  
  .comment-content {
    line-height: 1.5;
    margin-bottom: 10px;
  }
  
  /* Respuestas a comentarios */
  .comment-replies {
    margin-left: 20px;
    margin-top: 15px;
    border-left: 2px solid var(--border);
    padding-left: 15px;
  }
  
  .reply {
    background: var(--reply-bg);
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
    border-left: 2px solid var(--secondary);
  }
  
  .reply-header {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    margin-bottom: 5px;
  }
  
  .reply-author {
    font-weight: bold;
    color: var(--secondary);
  }
  
  .reply-time {
    color: var(--text-light);
    font-size: 0.8rem;
  }
  
  .reply-content {
    font-size: 0.95rem;
    line-height: 1.4;
  }
  
  .reply-form {
    margin-top: 10px;
    display: none;
  }
  
  .reply-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.9rem;
    resize: vertical;
    min-height: 60px;
    margin-bottom: 5px;
    font-family: inherit;
  }
  
  .reply-input:focus {
    outline: none;
    border-color: var(--secondary);
  }
  
  .comment-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  
  .btn-reply {
    background: none;
    border: none;
    color: var(--secondary);
    cursor: pointer;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border-radius: 4px;
    transition: background 0.3s;
  }
  
  .btn-reply:hover {
    background: rgba(52, 152, 219, 0.1);
  }
  
  .reply-count {
    font-size: 0.8rem;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 3px;
  }
  
  /* Encuestas y juegos */
  .poll-section {
    background: var(--light);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 25px;
  }
  
  .poll-options {
    display: flex;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  
  .poll-results {
    margin-top: 20px;
  }
  
  .poll-bar {
    height: 24px;
    background: #e0e0e0;
    border-radius: 12px;
    margin: 10px 0;
    overflow: hidden;
    position: relative;
  }
  
  .poll-fill {
    height: 100%;
    border-radius: 12px;
    transition: width 0.5s ease;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
  }
  
  /* Botones */
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-family: inherit;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--secondary);
  }
  
  .btn-secondary {
    background: var(--accent);
    color: white;
  }
  
  .btn-success {
    background: var(--success);
    color: white;
  }
  
  .btn-warning {
    background: var(--warning);
    color: white;
  }
  
  .btn-danger {
    background: var(--danger);
    color: white;
  }
  
  .btn-small {
    padding: 6px 12px;
    font-size: 0.9rem;
  }
  
  .btn-disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .btn-disabled:hover {
    transform: none;
    box-shadow: none;
  }
  
  /* Juego de reacci√≥n */
  .reaction-game {
    text-align: center;
    padding: 30px;
    background: linear-gradient(135deg, var(--light) 0%, #fff 100%);
    border-radius: 8px;
    margin-bottom: 25px;
  }
  
  .reaction-display {
    font-size: 2.5rem;
    font-weight: bold;
    padding: 40px;
    background: white;
    border-radius: 8px;
    margin: 20px 0;
    cursor: pointer;
    user-select: none;
    border: 3px solid var(--border);
    transition: all 0.2s;
  }
  
  .reaction-display.active {
    border-color: var(--success);
    background: #e8f5e8;
  }
  
  .reaction-display.ready {
    border-color: var(--warning);
    background: #fff8e1;
  }
  
  /* Usuarios conectados */
  .users-online {
    background: var(--light);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 25px;
  }
  
  .user-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
  }
  
  .user-tag {
    background: white;
    padding: 8px 15px;
    border-radius: 20px;
    border: 1px solid var(--border);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .user-tag::before {
    content: "";
    width: 10px;
    height: 10px;
    background: var(--success);
    border-radius: 50%;
  }
  
  /* Estado del equipo */
  .team-mood {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  
  .mood-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .mood-btn:hover:not(.disabled) {
    transform: scale(1.1);
  }
  
  .mood-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* Pie del peri√≥dico */
  .newspaper-footer {
    border-top: 4px double var(--dark);
    padding-top: 20px;
    margin-top: 40px;
    text-align: center;
    color: var(--text-light);
    font-size: 0.9rem;
  }
  
  /* Modal de sesi√≥n */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  
  .modal.active {
    display: flex;
  }
  
  .modal-content {
    background: white;
    padding: 40px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .newspaper-title {
      font-size: 2.5rem;
    }
    
    .session-info {
      flex-direction: column;
      align-items: stretch;
    }
    
    .session-form input {
      min-width: auto;
      width: 100%;
    }
    
    .article-title {
      font-size: 1.5rem;
    }
    
    .team-mood {
      flex-wrap: wrap;
    }
    
    .newspaper-date, .session-status {
      position: static;
      text-align: center;
      margin: 10px 0;
    }
    
    .comment-replies {
      margin-left: 10px;
      padding-left: 10px;
    }
  }
  
  /* Estilos para scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  
  ::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  
  /* Notificaciones */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    z-index: 1001;
    animation: slideInRight 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }
  
  .notification.success {
    background: var(--success);
  }
  
  .notification.error {
    background: var(--danger);
  }
  
  .notification.info {
    background: var(--accent);
  }
  
  .notification.warning {
    background: var(--warning);
  }
  
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  /* Indicador de voto diario */
  .vote-indicator {
    font-size: 0.85rem;
    color: var(--text-light);
    margin-top: 10px;
    padding: 8px 12px;
    background: var(--light);
    border-radius: 4px;
    display: inline-block;
  }
  
  .vote-indicator.voted {
    color: var(--success);
    background: rgba(39, 174, 96, 0.1);
    border-left: 3px solid var(--success);
  }
</style>
</head>
<body>

<div class="newspaper-container">
  <!-- Cabecera del peri√≥dico -->
  <header class="newspaper-header">
    <div class="session-status">
      <span class="status-indicator status-offline" id="statusIndicator"></span>
      <span id="statusText">Desconectado</span>
    </div>
    
    <div class="newspaper-date" id="currentDate"></div>
    
    <h1 class="newspaper-title">üóûÔ∏è Peri√≥dico Guacari</h1>
    <p class="newspaper-subtitle">Las noticias internas del equipo</p>
    <p class="newspaper-motto">LO QUE PASA AQU√ç SE QUEDA AQU√ç</p>
  </header>
  
  <!-- Secci√≥n de sesi√≥n -->
  <section class="session-section" id="sessionSection">
    <div id="loggedInSection" style="display: none;">
      <div class="session-info">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">?</div>
          <div class="user-details">
            <h3 id="userAlias">Usuario</h3>
            <p id="userStatus">Conectado ‚Ä¢ <span id="onlineCount">0</span> personas en l√≠nea</p>
          </div>
        </div>
        
        <div>
          <button class="btn btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
      </div>
    </div>
    
    <div id="loginSection">
      <h2>üìù Identif√≠cate para participar</h2>
      <p>Usa un alias para comentar, responder a compa√±eros y participar en encuestas.</p>
      
      <div class="session-form">
        <input type="text" id="aliasInput" placeholder="Tu alias (ej: ReporteroGuacari)" maxlength="20">
        <button class="btn btn-primary" onclick="login()">Entrar al Peri√≥dico</button>
      </div>
      
      <p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-light);">
        Tu alias se guardar√° autom√°ticamente para futuras visitas.
      </p>
    </div>
  </section>
  
  <!-- Grid principal del peri√≥dico -->
  <div class="newspaper-grid">
    <!-- Columna principal con art√≠culos -->
    <main class="main-articles">
      <!-- Art√≠culo 1: Mood del equipo -->
      <article class="article" id="moodArticle">
        <div class="article-header">
          <h2 class="article-title">üìä Estado de √Ånimo del Equipo</h2>
          <div class="article-meta">
            <span>Encuesta en vivo</span>
            <span id="moodUpdateTime">Actualizando...</span>
          </div>
        </div>
        
        <p>¬øC√≥mo se siente el equipo hoy? Vota y comenta sobre el estado de √°nimo general.</p>
        <p class="vote-indicator" id="moodVoteIndicator" style="display: none;">
          <small>‚ö†Ô∏è Solo puedes votar una vez al d√≠a</small>
        </p>
        
        <div class="team-mood">
          <button class="mood-btn" id="moodEstresado" style="background: #e74c3c; color: white;" onclick="voteMood('estresado')">üò´</button>
          <button class="mood-btn" id="moodNeutral" style="background: #3498db; color: white;" onclick="voteMood('neutral')">üòê</button>
          <button class="mood-btn" id="moodPositivo" style="background: #2ecc71; color: white;" onclick="voteMood('positivo')">üòä</button>
          <button class="mood-btn" id="moodMotivado" style="background: #9b59b6; color: white;" onclick="voteMood('motivado')">üöÄ</button>
        </div>
        
        <div class="poll-results" id="moodResults">
          <p>Cargando resultados...</p>
        </div>
        
        <div class="comments-section" id="moodCommentsSection">
          <h3>üí¨ Comentarios sobre el √°nimo del equipo <small>(Puedes responder a los compa√±eros)</small></h3>
          <div class="comment-form" style="display: none;" id="moodCommentForm">
            <textarea class="comment-input" id="moodCommentInput" placeholder="¬øPor qu√© votaste as√≠? Comparte tu opini√≥n..." maxlength="300"></textarea>
            <button class="btn btn-secondary" onclick="postMoodComment()">Publicar Comentario</button>
          </div>
          <div class="comments-list" id="moodComments">
            <p>Cargando comentarios...</p>
          </div>
        </div>
      </article>
      
      <!-- Art√≠culo 2: Caf√© vs T√© -->
      <article class="article" id="coffeeTeaArticle">
        <div class="article-header">
          <h2 class="article-title">‚òïüçµ Gran Debate: ¬øCaf√© o T√©?</h2>
          <div class="article-meta">
            <span>Encuesta permanente</span>
            <span id="pollUpdateTime">Actualizando...</span>
          </div>
        </div>
        
        <p>El eterno debate de la oficina: ¬øqu√© bebida predomina durante el break?</p>
        <p class="vote-indicator" id="pollVoteIndicator" style="display: none;">
          <small>‚ö†Ô∏è Solo puedes votar una vez al d√≠a</small>
        </p>
        
        <div class="poll-options">
          <button class="btn btn-warning" id="btnCafe" onclick="votePoll('cafe')">‚òï Caf√©</button>
          <button class="btn btn-success" id="btnTe" onclick="votePoll('te')">üçµ T√©</button>
          <button class="btn btn-secondary" id="btnAmbos" onclick="votePoll('ambos')">‚òïüçµ Ambos</button>
          <button class="btn btn-danger" id="btnNinguno" onclick="votePoll('ninguno')">üö´ Ninguno</button>
        </div>
        
        <div class="poll-results" id="pollResults">
          <p>Cargando resultados...</p>
        </div>
        
        <div class="comments-section" id="pollCommentsSection">
          <h3>üí¨ Comentarios sobre el debate <small>(Responde a tus compa√±eros)</small></h3>
          <div class="comment-form" style="display: none;" id="pollCommentForm">
            <textarea class="comment-input" id="pollCommentInput" placeholder="¬øPor qu√© prefieres caf√© o t√©?" maxlength="300"></textarea>
            <button class="btn btn-secondary" onclick="postPollComment()">Publicar Comentario</button>
          </div>
          <div class="comments-list" id="pollComments">
            <p>Cargando comentarios...</p>
          </div>
        </div>
      </article>
      
      <!-- Nuevo Art√≠culo: Foro Libre -->
      <article class="article" id="freeForum">
        <div class="article-header">
          <h2 class="article-title">üí¨ Foro Libre del Equipo</h2>
          <div class="article-meta">
            <span>Conversaciones generales</span>
            <span id="forumUpdateTime">Actualizando...</span>
          </div>
        </div>
        
        <p>Espacio para conversaciones libres, preguntas, ideas o lo que quieras compartir con el equipo.</p>
        
        <div class="comments-section" id="forumCommentsSection">
          <div class="comment-form" style="display: none;" id="forumCommentForm">
            <textarea class="comment-input" id="forumCommentInput" placeholder="¬øQu√© quieres compartir con el equipo?" maxlength="500"></textarea>
            <button class="btn btn-secondary" onclick="postForumComment()">Publicar en el Foro</button>
          </div>
          <div class="comments-list" id="forumComments">
            <p>Cargando conversaciones...</p>
          </div>
        </div>
      </article>
    </main>
    
    <!-- Sidebar -->
    <aside class="newspaper-sidebar">
      <!-- Juego de reacci√≥n -->
      <article class="reaction-game">
        <h2>‚ö° Prueba de Reflejos</h2>
        <p>Mide tu tiempo de reacci√≥n en este instante.</p>
        
        <div class="reaction-display" id="reactionDisplay">
          Haz clic en "Comenzar"
        </div>
        
        <button class="btn btn-primary" onclick="startReactionGame()" id="reactionBtn">Comenzar Prueba</button>
        
        <div id="reactionResult" style="margin-top: 20px; font-weight: bold;"></div>
        
        <div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-light);">
          Mejor tiempo: <span id="bestTime">-</span> ms
        </div>
      </article>
      
      <!-- Usuarios conectados -->
      <article class="users-online">
        <h2>üë• Equipo Conectado</h2>
        <p>Periodistas activos en este momento:</p>
        
        <div class="user-list" id="userList">
          <!-- Los usuarios se cargar√°n aqu√≠ -->
        </div>
      </article>
      
      <!-- Nota del editor -->
      <article class="article">
        <div class="article-header">
          <h2 class="article-title">‚úèÔ∏è Normas del Peri√≥dico</h2>
        </div>
        <p><strong>Votaciones:</strong> 1 voto por d√≠a por encuesta.</p>
        <p><strong>Comentarios:</strong> Responde a tus compa√±eros libremente.</p>
        <p><strong>Confidencialidad:</strong> Lo que pasa aqu√≠ se queda aqu√≠.</p>
        <p><strong>Respeto:</strong> S√© amable con todos los miembros.</p>
      </article>
    </aside>
  </div>
  
  <!-- Pie del peri√≥dico -->
  <footer class="newspaper-footer">
    <p>¬© 2023 Peri√≥dico Guacari - Todas las noticias se actualizan en tiempo real</p>
    <p id="footerInfo">Conectado como: <span id="footerUser">Invitado</span> | <span id="connectionStatus">‚ö´ Desconectado</span></p>
  </footer>
</div>

<!-- Modal de bienvenida -->
<div class="modal" id="welcomeModal">
  <div class="modal-content">
    <h2 style="margin-bottom: 20px; color: var(--primary);">ü¶â Bienvenido al Peri√≥dico Guacari</h2>
    <p><strong>"Lo que pasa aqu√≠ se queda aqu√≠"</strong></p>
    <p>Para participar en las discusiones, <strong>responder a compa√±eros</strong>, votar en encuestas y comentar noticias, necesitas identificarte con un alias.</p>
    <p>Tu alias ser√° tu identidad en el peri√≥dico y se guardar√° para futuras visitas.</p>
    
    <div style="margin-top: 25px;">
      <input type="text" id="modalAliasInput" placeholder="Ej: RedactorGuacari" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 4px; font-size: 1rem; margin-bottom: 15px;">
      <button class="btn btn-primary" onclick="loginFromModal()" style="width: 100%; padding: 15px; font-size: 1.1rem;">Entrar al Peri√≥dico</button>
    </div>
    
    <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-light); text-align: center;">
      Puedes cambiar tu alias en cualquier momento
    </p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, runTransaction, push, remove, onDisconnect, update, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyByB_5gP3sDwbCmVWbiB5CQXHzsKhcDvoo",
    authDomain: "chist-4aac2.firebaseapp.com",
    databaseURL: "https://chist-4aac2-default-rtdb.firebaseio.com",
    projectId: "chist-4aac2",
    storageBucket: "chist-4aac2.firebasestorage.app",
    messagingSenderId: "64011595640",
    appId: "1:64011595640:web:8fa8b005b916cf2af7628d",
    measurementId: "G-8NXX8FKF54"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  // Variables globales
  let currentUser = {
    id: null,
    alias: null,
    isLoggedIn: false
  };
  
  let reactionGame = {
    startTime: null,
    active: false,
    bestTime: localStorage.getItem('bestReactionTime') || null
  };
  
  // Inicializar la aplicaci√≥n
  async function initApp() {
    console.log("Iniciando aplicaci√≥n...");
    
    // Establecer fecha actual
    updateDate();
    
    // Verificar si hay un usuario guardado
    const savedUser = localStorage.getItem('guacariUser');
    if (savedUser) {
      try {
        console.log("Usuario encontrado en localStorage:", savedUser);
        const userData = JSON.parse(savedUser);
        currentUser = {
          id: userData.id,
          alias: userData.alias,
          isLoggedIn: true
        };
        
        // Actualizar UI inmediatamente
        updateUserUI();
        
        // Inicializar sesi√≥n en Firebase
        await initializeSession();
        
        // Verificar estado de votos
        await checkVoteStatus();
        
        // Mostrar bienvenida
        showNotification(`¬°Bienvenido de nuevo, ${currentUser.alias}!`, 'success');
      } catch (e) {
        console.error("Error cargando usuario:", e);
        showLoginModal();
      }
    } else {
      console.log("No hay usuario guardado, mostrando modal...");
      // Mostrar modal de inicio de sesi√≥n despu√©s de un breve retraso
      setTimeout(() => {
        showLoginModal();
      }, 500);
    }
    
    // Cargar mejor tiempo de reacci√≥n
    if (reactionGame.bestTime) {
      document.getElementById('bestTime').textContent = reactionGame.bestTime;
    }
    
    // Configurar listeners de Firebase
    setupFirebaseListeners();
  }
  
  // Actualizar fecha
  function updateDate() {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('currentDate').textContent = now.toLocaleDateString('es-ES', options);
  }
  
  // Mostrar modal de inicio de sesi√≥n
  function showLoginModal() {
    console.log("Mostrando modal de login");
    document.getElementById('welcomeModal').classList.add('active');
    document.getElementById('modalAliasInput').focus();
  }
  
  // Cerrar modal de inicio de sesi√≥n
  function closeLoginModal() {
    document.getElementById('welcomeModal').classList.remove('active');
  }
  
  // Iniciar sesi√≥n desde el modal
  async function loginFromModal() {
    const aliasInput = document.getElementById('modalAliasInput');
    const alias = aliasInput.value.trim();
    
    if (!validateAlias(alias)) return;
    
    await performLogin(alias);
    closeLoginModal();
  }
  
  // Iniciar sesi√≥n desde el formulario principal
  async function login() {
    const aliasInput = document.getElementById('aliasInput');
    const alias = aliasInput.value.trim();
    
    if (!validateAlias(alias)) return;
    
    await performLogin(alias);
  }
  
  // Validar alias
  function validateAlias(alias) {
    if (alias.length < 2) {
      showNotification("Por favor, introduce un alias de al menos 2 caracteres", 'error');
      return false;
    }
    
    if (alias.length > 20) {
      showNotification("El alias no puede tener m√°s de 20 caracteres", 'error');
      return false;
    }
    
    // Validar caracteres permitidos
    const validChars = /^[a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë ]+$/;
    if (!validChars.test(alias)) {
      showNotification("Solo se permiten letras, n√∫meros y espacios", 'error');
      return false;
    }
    
    return true;
  }
  
  // Realizar el proceso de login
  async function performLogin(alias) {
    console.log("Realizando login con alias:", alias);
    
    // Crear ID de usuario √∫nico
    const userId = generateUserId(alias);
    
    // Guardar usuario localmente
    currentUser = {
      id: userId,
      alias: alias,
      isLoggedIn: true
    };
    
    // Guardar en localStorage
    localStorage.setItem('guacariUser', JSON.stringify(currentUser));
    console.log("Usuario guardado en localStorage");
    
    // Actualizar UI
    updateUserUI();
    
    // Inicializar sesi√≥n en Firebase
    await initializeSession();
    
    // Verificar estado de votos
    await checkVoteStatus();
    
    // Mostrar notificaci√≥n
    showNotification(`¬°Bienvenido al peri√≥dico, ${alias}!`, 'success');
  }
  
  // Generar ID de usuario √∫nico
  function generateUserId(alias) {
    const timestamp = Date.now().toString(36);
    const randomStr = Math.random().toString(36).substring(2, 8);
    const aliasHash = Array.from(alias).reduce((acc, char) => acc + char.charCodeAt(0), 0);
    return `user_${aliasHash}_${timestamp}_${randomStr}`;
  }
  
  // Actualizar UI con informaci√≥n del usuario
  function updateUserUI() {
    console.log("Actualizando UI, usuario logueado:", currentUser.isLoggedIn);
    
    if (currentUser.isLoggedIn) {
      // Mostrar secci√≥n de usuario logueado
      document.getElementById('loggedInSection').style.display = 'block';
      document.getElementById('loginSection').style.display = 'none';
      
      // Mostrar formularios de comentarios
      document.querySelectorAll('.comment-form').forEach(form => {
        form.style.display = 'flex';
      });
      
      // Actualizar informaci√≥n del usuario
      document.getElementById('userAlias').textContent = currentUser.alias;
      document.getElementById('footerUser').textContent = currentUser.alias;
      updateAvatar();
      
      // Actualizar estado de conexi√≥n
      document.getElementById('statusIndicator').className = 'status-indicator status-online';
      document.getElementById('statusText').textContent = 'Conectado';
      document.getElementById('connectionStatus').textContent = 'üü¢ Conectado';
      document.getElementById('connectionStatus').style.color = '#27ae60';
      
      // Poner el alias en el input por si quiere cambiarlo
      document.getElementById('aliasInput').value = currentUser.alias;
      document.getElementById('modalAliasInput').value = currentUser.alias;
    } else {
      // Mostrar secci√≥n de login
      document.getElementById('loggedInSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      
      // Ocultar formularios de comentarios
      document.querySelectorAll('.comment-form').forEach(form => {
        form.style.display = 'none';
      });
      
      // Actualizar estado de conexi√≥n
      document.getElementById('statusIndicator').className = 'status-indicator status-offline';
      document.getElementById('statusText').textContent = 'Desconectado';
      document.getElementById('connectionStatus').textContent = '‚ö´ Desconectado';
      document.getElementById('connectionStatus').style.color = '#7f8c8d';
      document.getElementById('footerUser').textContent = 'Invitado';
      
      // Deshabilitar botones de voto
      disableVoteButtons();
    }
  }
  
  // Actualizar avatar
  function updateAvatar() {
    const avatarElement = document.getElementById('userAvatar');
    if (currentUser.alias && currentUser.alias !== "Invitado") {
      // Usar las dos primeras letras del alias para el avatar
      const initials = currentUser.alias.substring(0, 2).toUpperCase();
      avatarElement.textContent = initials;
    } else {
      avatarElement.textContent = "?";
    }
  }
  
  // Inicializar sesi√≥n en Firebase
  async function initializeSession() {
    if (!currentUser.isLoggedIn) {
      console.log("No hay usuario logueado, no se inicializa sesi√≥n en Firebase");
      return;
    }
    
    console.log("Inicializando sesi√≥n en Firebase para:", currentUser.id);
    
    const userRef = ref(db, "users/" + currentUser.id);
    
    try {
      // Verificar si el usuario ya existe
      const snapshot = await get(userRef);
      const userExists = snapshot.exists();
      
      // Datos del usuario
      const userData = {
        alias: currentUser.alias,
        lastActive: Date.now(),
        online: true,
        sessionStart: Date.now(),
        updatedAt: Date.now()
      };
      
      if (userExists) {
        // Actualizar usuario existente
        await update(userRef, userData);
        console.log("Usuario actualizado en Firebase");
      } else {
        // Crear nuevo usuario
        await set(userRef, userData);
        console.log("Nuevo usuario creado en Firebase");
      }
      
      // Configurar desconexi√≥n
      onDisconnect(userRef).update({
        online: false,
        lastActive: Date.now(),
        updatedAt: Date.now()
      });
      
      console.log("Sesi√≥n inicializada correctamente en Firebase");
      
      // Actualizar actividad peri√≥dicamente
      setInterval(async () => {
        if (currentUser.isLoggedIn) {
          try {
            await update(userRef, {
              lastActive: Date.now(),
              updatedAt: Date.now()
            });
          } catch (error) {
            console.error("Error actualizando actividad:", error);
          }
        }
      }, 30000); // Cada 30 segundos
      
    } catch (error) {
      console.error("Error inicializando sesi√≥n en Firebase:", error);
      showNotification("Error al conectar con el servidor", 'error');
    }
  }
  
  // Verificar estado de votos del usuario
  async function checkVoteStatus() {
    if (!currentUser.isLoggedIn) return;
    
    try {
      const today = new Date().toDateString();
      
      // Verificar votos de mood
      const moodVoteRef = ref(db, `moodVotes/${currentUser.id}`);
      const moodSnapshot = await get(moodVoteRef);
      
      if (moodSnapshot.exists()) {
        const moodVote = moodSnapshot.val();
        const voteDate = new Date(moodVote.timestamp).toDateString();
        
        if (voteDate === today) {
          // El usuario ya vot√≥ hoy en mood
          document.getElementById('moodVoteIndicator').style.display = 'block';
          document.getElementById('moodVoteIndicator').className = 'vote-indicator voted';
          document.getElementById('moodVoteIndicator').innerHTML = '‚úÖ Ya votaste hoy en Mood del Equipo';
          disableMoodButtons();
        }
      }
      
      // Verificar votos de poll
      const pollVoteRef = ref(db, `pollVotes/${currentUser.id}`);
      const pollSnapshot = await get(pollVoteRef);
      
      if (pollSnapshot.exists()) {
        const pollVote = pollSnapshot.val();
        const voteDate = new Date(pollVote.timestamp).toDateString();
        
        if (voteDate === today) {
          // El usuario ya vot√≥ hoy en poll
          document.getElementById('pollVoteIndicator').style.display = 'block';
          document.getElementById('pollVoteIndicator').className = 'vote-indicator voted';
          document.getElementById('pollVoteIndicator').innerHTML = '‚úÖ Ya votaste hoy en Caf√© vs T√©';
          disablePollButtons();
        }
      }
      
    } catch (error) {
      console.error("Error verificando estado de votos:", error);
    }
  }
  
  // Deshabilitar botones de voto
  function disableVoteButtons() {
    // Deshabilitar botones de mood
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.disabled = true;
      btn.classList.add('disabled');
    });
    
    // Deshabilitar botones de poll
    document.querySelectorAll('.poll-options .btn').forEach(btn => {
      btn.disabled = true;
      btn.classList.add('disabled');
    });
  }
  
  // Deshabilitar botones de mood
  function disableMoodButtons() {
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.disabled = true;
      btn.classList.add('disabled');
    });
  }
  
  // Deshabilitar botones de poll
  function disablePollButtons() {
    document.querySelectorAll('.poll-options .btn').forEach(btn => {
      btn.disabled = true;
      btn.classList.add('disabled');
    });
  }
  
  // Configurar listeners de Firebase
  function setupFirebaseListeners() {
    console.log("Configurando listeners de Firebase...");
    
    // Usuarios conectados
    const usersRef = ref(db, "users");
    onValue(usersRef, (snapshot) => {
      console.log("Datos de usuarios recibidos:", snapshot.exists());
      
      if (!snapshot.exists()) {
        document.getElementById('onlineCount').textContent = '0';
        document.getElementById('userList').innerHTML = '<p>No hay usuarios conectados</p>';
        return;
      }
      
      const users = snapshot.val();
      const onlineUsers = Object.values(users).filter(user => user && user.online);
      
      // Actualizar contador
      const onlineCount = onlineUsers.length;
      document.getElementById('onlineCount').textContent = onlineCount;
      
      // Actualizar lista de usuarios
      const userListHTML = onlineUsers
        .slice(0, 8) // Mostrar m√°ximo 8 usuarios
        .map(user => `
          <div class="user-tag">
            ${user.alias || 'Usuario'}
          </div>
        `).join('');
      
      document.getElementById('userList').innerHTML = userListHTML || '<p>No hay usuarios conectados</p>';
      
      // Si hay m√°s de 8 usuarios, mostrar contador
      if (onlineUsers.length > 8) {
        document.getElementById('userList').innerHTML += `
          <div class="user-tag">
            +${onlineUsers.length - 8} m√°s
          </div>
        `;
      }
    }, (error) => {
      console.error("Error en listener de usuarios:", error);
    });
    
    // Mood del equipo
    const moodRef = ref(db, "mood");
    onValue(moodRef, (snapshot) => {
      const now = new Date();
      const timeString = now.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
      document.getElementById('moodUpdateTime').textContent = `Actualizado: ${timeString}`;
      
      if (!snapshot.exists()) {
        document.getElementById('moodResults').innerHTML = '<p>No hay votos a√∫n. ¬°S√© el primero!</p>';
        return;
      }
      
      const votes = snapshot.val();
      const counts = {
        estresado: 0,
        neutral: 0,
        positivo: 0,
        motivado: 0
      };
      
      // Contar votos
      Object.values(votes).forEach(vote => {
        if (vote && vote.mood && counts.hasOwnProperty(vote.mood)) {
          counts[vote.mood]++;
        }
      });
      
      // Calcular total
      const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
      
      // Actualizar UI
      if (total === 0) {
        document.getElementById('moodResults').innerHTML = '<p>No hay votos a√∫n. ¬°S√© el primero!</p>';
        return;
      }
      
      // Crear HTML de resultados
      const moodResultsHTML = `
        <div class="poll-results">
          <p>üò´ Estresado: ${counts.estresado} votos (${Math.round((counts.estresado/total)*100)}%)</p>
          <div class="poll-bar">
            <div class="poll-fill" style="width: ${(counts.estresado/total)*100}%; background: #e74c3c;">${Math.round((counts.estresado/total)*100)}%</div>
          </div>
          
          <p>üòê Neutral: ${counts.neutral} votos (${Math.round((counts.neutral/total)*100)}%)</p>
          <div class="poll-bar">
            <div class="poll-fill" style="width: ${(counts.neutral/total)*100}%; background: #3498db;">${Math.round((counts.neutral/total)*100)}%</div>
          </div>
          
          <p>üòä Positivo: ${counts.positivo} votos (${Math.round((counts.positivo/total)*100)}%)</p>
          <div class="poll-bar">
            <div class="poll-fill" style="width: ${(counts.positivo/total)*100}%; background: #2ecc71;">${Math.round((counts.positivo/total)*100)}%</div>
          </div>
          
          <p>üöÄ Motivado: ${counts.motivado} votos (${Math.round((counts.motivado/total)*100)}%)</p>
          <div class="poll-bar">
            <div class="poll-fill" style="width: ${(counts.motivado/total)*100}%; background: #9b59b6;">${Math.round((counts.motivado/total)*100)}%</div>
          </div>
          
          <p style="margin-top: 10px; text-align: center; font-weight: bold;">Total de votos: ${total}</p>
        </div>
      `;
      
      document.getElementById('moodResults').innerHTML = moodResultsHTML;
    });
    
    // Comentarios sobre el mood CON RESPUESTAS
    const moodCommentsRef = ref(db, "moodComments");
    onValue(moodCommentsRef, (snapshot) => {
      const commentsContainer = document.getElementById('moodComments');
      
      if (!snapshot.exists()) {
        commentsContainer.innerHTML = '<p>No hay comentarios a√∫n. ¬°S√© el primero en comentar!</p>';
        return;
      }
      
      const comments = snapshot.val();
      const commentsArray = Object.entries(comments)
        .map(([id, comment]) => ({ 
          id, 
          ...comment,
          replies: comment.replies || {}
        }))
        .sort((a, b) => b.timestamp - a.timestamp); // M√°s recientes primero
      
      const commentsHTML = commentsArray.slice(0, 10).map(comment => renderComment(comment, 'mood'));
      commentsContainer.innerHTML = commentsHTML.join('') || '<p>No hay comentarios a√∫n.</p>';
    });
    
    // Encuesta Caf√© vs T√©
    const pollRef = ref(db, "poll");
    onValue(pollRef, (snapshot) => {
      const now = new Date();
      const timeString = now.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
      document.getElementById('pollUpdateTime').textContent = `Actualizado: ${timeString}`;
      
      if (!snapshot.exists()) {
        document.getElementById('pollResults').innerHTML = '<p>No hay votos a√∫n. ¬°S√© el primero!</p>';
        return;
      }
      
      const poll = snapshot.val();
      const counts = {
        cafe: poll.cafe || 0,
        te: poll.te || 0,
        ambos: poll.ambos || 0,
        ninguno: poll.ninguno || 0
      };
      
      // Calcular total
      const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
      
      // Actualizar UI
      if (total === 0) {
        document.getElementById('pollResults').innerHTML = '<p>No hay votos a√∫n. ¬°S√© el primero!</p>';
        return;
      }
      
      // Crear HTML de resultados
      const pollResultsHTML = `
        <div class="poll-results">
          <p>‚òï Caf√©: ${counts.cafe} votos (${Math.round((counts.cafe/total)*100)}%)</p>
          <div class="poll-bar">
            <div class="poll-fill" style="width: ${(counts.cafe/total)*100}%; background: #f39c12;">${Math.round((counts.cafe/total)*100)}%</div>
          </div>
          
          <p>üçµ T√©: ${counts.te} votos (${Math.round((counts.te/total)*100)}%)</p>
          <div class="poll-bar">
            <div class="poll-fill" style="width: ${(counts.te/total)*100}%; background: #27ae60;">${Math.round((counts.te/total)*100)}%</div>
          </div>
          
          <p>‚òïüçµ Ambos: ${counts.ambos} votos (${Math.round((counts.ambos/total)*100)}%)</p>
          <div class="poll-bar">
            <div class="poll-fill" style="width: ${(counts.ambos/total)*100}%; background: #3498db;">${Math.round((counts.ambos/total)*100)}%</div>
          </div>
          
          <p>üö´ Ninguno: ${counts.ninguno} votos (${Math.round((counts.ninguno/total)*100)}%)</p>
          <div class="poll-bar">
            <div class="poll-fill" style="width: ${(counts.ninguno/total)*100}%; background: #e74c3c;">${Math.round((counts.ninguno/total)*100)}%</div>
          </div>
          
          <p style="margin-top: 10px; text-align: center; font-weight: bold;">Total de votos: ${total}</p>
        </div>
      `;
      
      document.getElementById('pollResults').innerHTML = pollResultsHTML;
    });
    
    // Comentarios sobre la encuesta CON RESPUESTAS
    const pollCommentsRef = ref(db, "pollComments");
    onValue(pollCommentsRef, (snapshot) => {
      const commentsContainer = document.getElementById('pollComments');
      
      if (!snapshot.exists()) {
        commentsContainer.innerHTML = '<p>No hay comentarios a√∫n. ¬°S√© el primero en comentar!</p>';
        return;
      }
      
      const comments = snapshot.val();
      const commentsArray = Object.entries(comments)
        .map(([id, comment]) => ({ 
          id, 
          ...comment,
          replies: comment.replies || {}
        }))
        .sort((a, b) => b.timestamp - a.timestamp); // M√°s recientes primero
      
      const commentsHTML = commentsArray.slice(0, 10).map(comment => renderComment(comment, 'poll'));
      commentsContainer.innerHTML = commentsHTML.join('') || '<p>No hay comentarios a√∫n.</p>';
    });
    
    // Foro libre CON RESPUESTAS
    const forumCommentsRef = ref(db, "forumComments");
    onValue(forumCommentsRef, (snapshot) => {
      const now = new Date();
      const timeString = now.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
      document.getElementById('forumUpdateTime').textContent = `Actualizado: ${timeString}`;
      
      const commentsContainer = document.getElementById('forumComments');
      
      if (!snapshot.exists()) {
        commentsContainer.innerHTML = '<p>No hay conversaciones a√∫n. ¬°Inicia una!</p>';
        return;
      }
      
      const comments = snapshot.val();
      const commentsArray = Object.entries(comments)
        .map(([id, comment]) => ({ 
          id, 
          ...comment,
          replies: comment.replies || {}
        }))
        .sort((a, b) => b.timestamp - a.timestamp); // M√°s recientes primero
      
      const commentsHTML = commentsArray.slice(0, 15).map(comment => renderComment(comment, 'forum'));
      commentsContainer.innerHTML = commentsHTML.join('') || '<p>No hay conversaciones a√∫n.</p>';
    });
  }
  
  // Renderizar comentario con sistema de respuestas
  function renderComment(comment, section) {
    const replies = comment.replies ? Object.values(comment.replies) : [];
    const replyCount = replies.length;
    
    // Ordenar respuestas por timestamp (m√°s recientes primero)
    const sortedReplies = [...replies].sort((a, b) => a.timestamp - b.timestamp);
    
    const repliesHTML = sortedReplies.map(reply => `
      <div class="reply">
        <div class="reply-header">
          <span class="reply-author">${reply.alias || 'An√≥nimo'}</span>
          <span class="reply-time">${formatTime(reply.timestamp)}</span>
        </div>
        <div class="reply-content">${reply.text || ''}</div>
      </div>
    `).join('');
    
    return `
      <div class="comment" id="comment-${section}-${comment.id}">
        <div class="comment-header">
          <span class="comment-author">${comment.alias || 'An√≥nimo'}</span>
          <span class="comment-time">${formatTime(comment.timestamp)}</span>
        </div>
        <div class="comment-content">${comment.text || ''}</div>
        
        <div class="comment-actions">
          <button class="btn-reply" onclick="showReplyForm('${section}', '${comment.id}')">
            <span>üí¨ Responder</span>
          </button>
          ${replyCount > 0 ? `
            <span class="reply-count">
              ${replyCount} ${replyCount === 1 ? 'respuesta' : 'respuestas'}
            </span>
          ` : ''}
        </div>
        
        <div class="reply-form" id="reply-form-${section}-${comment.id}">
          <textarea class="reply-input" id="reply-input-${section}-${comment.id}" placeholder="Escribe tu respuesta..." maxlength="200"></textarea>
          <button class="btn btn-small btn-secondary" onclick="postReply('${section}', '${comment.id}')">Enviar Respuesta</button>
          <button class="btn btn-small" onclick="hideReplyForm('${section}', '${comment.id}')" style="margin-left: 5px;">Cancelar</button>
        </div>
        
        ${replyCount > 0 ? `
          <div class="comment-replies">
            ${repliesHTML}
          </div>
        ` : ''}
      </div>
    `;
  }
  
  // Mostrar formulario de respuesta
  function showReplyForm(section, commentId) {
    if (!currentUser.isLoggedIn) {
      showNotification("Debes iniciar sesi√≥n para responder", 'error');
      showLoginModal();
      return;
    }
    
    // Ocultar otros formularios de respuesta
    document.querySelectorAll('.reply-form').forEach(form => {
      form.style.display = 'none';
    });
    
    // Mostrar este formulario
    const replyForm = document.getElementById(`reply-form-${section}-${commentId}`);
    if (replyForm) {
      replyForm.style.display = 'block';
      const replyInput = document.getElementById(`reply-input-${section}-${commentId}`);
      if (replyInput) {
        replyInput.focus();
      }
    }
  }
  
  // Ocultar formulario de respuesta
  function hideReplyForm(section, commentId) {
    const replyForm = document.getElementById(`reply-form-${section}-${commentId}`);
    if (replyForm) {
      replyForm.style.display = 'none';
      const replyInput = document.getElementById(`reply-input-${section}-${commentId}`);
      if (replyInput) {
        replyInput.value = '';
      }
    }
  }
  
  // Funciones para votar - CON L√çMITE DIARIO
  async function voteMood(mood) {
    if (!currentUser.isLoggedIn) {
      showNotification("Debes iniciar sesi√≥n para votar", 'error');
      showLoginModal();
      return;
    }
    
    // Verificar si ya vot√≥ hoy
    const today = new Date().toDateString();
    const moodVoteRef = ref(db, `moodVotes/${currentUser.id}`);
    const moodSnapshot = await get(moodVoteRef);
    
    if (moodSnapshot.exists()) {
      const moodVote = moodSnapshot.val();
      const voteDate = new Date(moodVote.timestamp).toDateString();
      
      if (voteDate === today) {
        showNotification("Ya votaste hoy en Mood del Equipo. Vuelve ma√±ana.", 'warning');
        return;
      }
    }
    
    try {
      const moodRef = ref(db, "mood/" + currentUser.id);
      
      await set(moodRef, {
        mood: mood,
        alias: currentUser.alias,
        timestamp: Date.now(),
        userId: currentUser.id
      });
      
      // Registrar el voto del usuario con timestamp
      const userMoodVoteRef = ref(db, `moodVotes/${currentUser.id}`);
      await set(userMoodVoteRef, {
        mood: mood,
        timestamp: Date.now(),
        date: today
      });
      
      // Actualizar UI
      document.getElementById('moodVoteIndicator').style.display = 'block';
      document.getElementById('moodVoteIndicator').className = 'vote-indicator voted';
      document.getElementById('moodVoteIndicator').innerHTML = '‚úÖ Ya votaste hoy en Mood del Equipo';
      disableMoodButtons();
      
      showNotification(`¬°Votaste: ${getMoodText(mood)}! (1 voto por d√≠a)`, 'success');
    } catch (error) {
      console.error("Error votando mood:", error);
      showNotification("Error al votar", 'error');
    }
  }
  
  function getMoodText(mood) {
    const moods = {
      estresado: "üò´ Estresado",
      neutral: "üòê Neutral",
      positivo: "üòä Positivo",
      motivado: "üöÄ Motivado"
    };
    return moods[mood] || mood;
  }
  
  async function votePoll(option) {
    if (!currentUser.isLoggedIn) {
      showNotification("Debes iniciar sesi√≥n para votar", 'error');
      showLoginModal();
      return;
    }
    
    // Verificar si ya vot√≥ hoy
    const today = new Date().toDateString();
    const pollVoteRef = ref(db, `pollVotes/${currentUser.id}`);
    const pollSnapshot = await get(pollVoteRef);
    
    if (pollSnapshot.exists()) {
      const pollVote = pollSnapshot.val();
      const voteDate = new Date(pollVote.timestamp).toDateString();
      
      if (voteDate === today) {
        showNotification("Ya votaste hoy en Caf√© vs T√©. Vuelve ma√±ana.", 'warning');
        return;
      }
    }
    
    try {
      // Registrar voto en la encuesta
      await runTransaction(ref(db, "poll/" + option), n => (n || 0) + 1);
      
      // Registrar qui√©n vot√≥ y cu√°ndo
      const voteRef = ref(db, `pollVotes/${currentUser.id}`);
      await set(voteRef, {
        option: option,
        alias: currentUser.alias,
        timestamp: Date.now(),
        userId: currentUser.id,
        date: today
      });
      
      // Actualizar UI
      document.getElementById('pollVoteIndicator').style.display = 'block';
      document.getElementById('pollVoteIndicator').className = 'vote-indicator voted';
      document.getElementById('pollVoteIndicator').innerHTML = '‚úÖ Ya votaste hoy en Caf√© vs T√©';
      disablePollButtons();
      
      const optionText = {
        cafe: "‚òï Caf√©",
        te: "üçµ T√©",
        ambos: "‚òïüçµ Ambos",
        ninguno: "üö´ Ninguno"
      }[option] || option;
      
      showNotification(`¬°Votaste: ${optionText}! (1 voto por d√≠a)`, 'success');
    } catch (error) {
      console.error("Error votando en la encuesta:", error);
      showNotification("Error al votar", 'error');
    }
  }
  
  // Funciones para comentarios
  async function postMoodComment() {
    if (!currentUser.isLoggedIn) {
      showNotification("Debes iniciar sesi√≥n para comentar", 'error');
      showLoginModal();
      return;
    }
    
    const commentInput = document.getElementById('moodCommentInput');
    const text = commentInput.value.trim();
    
    if (text.length === 0) {
      showNotification("Por favor, escribe un comentario", 'error');
      return;
    }
    
    if (text.length > 300) {
      showNotification("El comentario no puede tener m√°s de 300 caracteres", 'error');
      return;
    }
    
    try {
      const commentRef = push(ref(db, "moodComments"));
      
      await set(commentRef, {
        alias: currentUser.alias,
        text: text,
        timestamp: Date.now(),
        userId: currentUser.id,
        replies: {}
      });
      
      // Limpiar input
      commentInput.value = '';
      
      // Mostrar notificaci√≥n
      showNotification("¬°Comentario publicado!", 'success');
    } catch (error) {
      console.error("Error publicando comentario:", error);
      showNotification("Error al publicar comentario", 'error');
    }
  }
  
  async function postPollComment() {
    if (!currentUser.isLoggedIn) {
      showNotification("Debes iniciar sesi√≥n para comentar", 'error');
      showLoginModal();
      return;
    }
    
    const commentInput = document.getElementById('pollCommentInput');
    const text = commentInput.value.trim();
    
    if (text.length === 0) {
      showNotification("Por favor, escribe un comentario", 'error');
      return;
    }
    
    if (text.length > 300) {
      showNotification("El comentario no puede tener m√°s de 300 caracteres", 'error');
      return;
    }
    
    try {
      const commentRef = push(ref(db, "pollComments"));
      
      await set(commentRef, {
        alias: currentUser.alias,
        text: text,
        timestamp: Date.now(),
        userId: currentUser.id,
        replies: {}
      });
      
      // Limpiar input
      commentInput.value = '';
      
      // Mostrar notificaci√≥n
      showNotification("¬°Comentario publicado!", 'success');
    } catch (error) {
      console.error("Error publicando comentario:", error);
      showNotification("Error al publicar comentario", 'error');
    }
  }
  
  async function postForumComment() {
    if (!currentUser.isLoggedIn) {
      showNotification("Debes iniciar sesi√≥n para comentar", 'error');
      showLoginModal();
      return;
    }
    
    const commentInput = document.getElementById('forumCommentInput');
    const text = commentInput.value.trim();
    
    if (text.length === 0) {
      showNotification("Por favor, escribe un comentario", 'error');
      return;
    }
    
    if (text.length > 500) {
      showNotification("El comentario no puede tener m√°s de 500 caracteres", 'error');
      return;
    }
    
    try {
      const commentRef = push(ref(db, "forumComments"));
      
      await set(commentRef, {
        alias: currentUser.alias,
        text: text,
        timestamp: Date.now(),
        userId: currentUser.id,
        replies: {}
      });
      
      // Limpiar input
      commentInput.value = '';
      
      // Mostrar notificaci√≥n
      showNotification("¬°Publicado en el foro!", 'success');
    } catch (error) {
      console.error("Error publicando en el foro:", error);
      showNotification("Error al publicar en el foro", 'error');
    }
  }
  
  // Publicar respuesta a un comentario
  async function postReply(section, commentId) {
    if (!currentUser.isLoggedIn) {
      showNotification("Debes iniciar sesi√≥n para responder", 'error');
      showLoginModal();
      return;
    }
    
    const replyInput = document.getElementById(`reply-input-${section}-${commentId}`);
    const text = replyInput.value.trim();
    
    if (text.length === 0) {
      showNotification("Por favor, escribe una respuesta", 'error');
      return;
    }
    
    if (text.length > 200) {
      showNotification("La respuesta no puede tener m√°s de 200 caracteres", 'error');
      return;
    }
    
    try {
      // Determinar la referencia correcta seg√∫n la secci√≥n
      let sectionRef;
      switch(section) {
        case 'mood':
          sectionRef = "moodComments";
          break;
        case 'poll':
          sectionRef = "pollComments";
          break;
        case 'forum':
          sectionRef = "forumComments";
          break;
        default:
          sectionRef = "forumComments";
      }
      
      const commentRef = ref(db, `${sectionRef}/${commentId}`);
      const replyId = `reply_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      // Crear la respuesta
      const replyData = {
        alias: currentUser.alias,
        text: text,
        timestamp: Date.now(),
        userId: currentUser.id
      };
      
      // Actualizar el comentario para a√±adir la respuesta
      await update(ref(db, `${sectionRef}/${commentId}/replies/${replyId}`), replyData);
      
      // Limpiar input
      replyInput.value = '';
      
      // Ocultar formulario
      hideReplyForm(section, commentId);
      
      // Mostrar notificaci√≥n
      showNotification("¬°Respuesta publicada!", 'success');
    } catch (error) {
      console.error("Error publicando respuesta:", error);
      showNotification("Error al publicar respuesta", 'error');
    }
  }
  
  // Juego de reacci√≥n
  function startReactionGame() {
    if (!currentUser.isLoggedIn) {
      showNotification("Debes iniciar sesi√≥n para jugar", 'error');
      showLoginModal();
      return;
    }
    
    if (reactionGame.active) return;
    
    reactionGame.active = true;
    reactionGame.startTime = null;
    
    const display = document.getElementById('reactionDisplay');
    const button = document.getElementById('reactionBtn');
    
    // Estado inicial
    display.textContent = "Preparado...";
    display.className = "reaction-display ready";
    display.style.cursor = "default";
    display.onclick = null;
    button.disabled = true;
    button.textContent = "Espera...";
    document.getElementById('reactionResult').innerHTML = '';
    
    // Tiempo aleatorio entre 2 y 5 segundos
    const waitTime = Math.random() * 3000 + 2000;
    
    setTimeout(() => {
      if (!reactionGame.active) return;
      
      // Cambiar a "¬°Ahora!"
      display.textContent = "¬°TOCA AHORA!";
      display.className = "reaction-display active";
      display.style.cursor = "pointer";
      reactionGame.startTime = Date.now();
      
      // Configurar evento de clic
      display.onclick = handleReactionClick;
      
      // Tiempo l√≠mite
      setTimeout(() => {
        if (reactionGame.active) {
          display.textContent = "¬°Demasiado tarde!";
          display.className = "reaction-display";
          display.style.cursor = "default";
          display.onclick = null;
          reactionGame.active = false;
          button.disabled = false;
          button.textContent = "Comenzar Prueba";
          document.getElementById('reactionResult').innerHTML = '<div style="color: #e74c3c;">No reaccionaste a tiempo</div>';
        }
      }, 3000); // 3 segundos para reaccionar
    }, waitTime);
  }
  
  function handleReactionClick() {
    if (!reactionGame.active || !reactionGame.startTime) return;
    
    const reactionTime = Date.now() - reactionGame.startTime;
    const display = document.getElementById('reactionDisplay');
    const button = document.getElementById('reactionBtn');
    
    // Desactivar juego
    reactionGame.active = false;
    display.onclick = null;
    
    // Mostrar resultado
    display.textContent = `${reactionTime} ms`;
    display.className = "reaction-display";
    display.style.cursor = "default";
    
    // Habilitar bot√≥n
    button.disabled = false;
    button.textContent = "Comenzar Prueba";
    
    // Evaluar resultado
    let message = "";
    let color = "#3498db";
    
    if (reactionTime < 200) {
      message = "¬°Incre√≠ble! ¬øEres un superh√©roe? ü¶∏";
      color = "#9b59b6";
    } else if (reactionTime < 300) {
      message = "¬°Excelente! Reflejos asombrosos ‚ö°";
      color = "#27ae60";
    } else if (reactionTime < 400) {
      message = "¬°Muy bien! Buenos reflejos üëç";
      color = "#2ecc71";
    } else if (reactionTime < 600) {
      message = "¬°Bien! Tiempo normal üòä";
      color = "#3498db";
    } else {
      message = "¬°Necesitas m√°s caf√©! ‚òï";
      color = "#e67e22";
    }
    
    document.getElementById('reactionResult').innerHTML = `
      <div style="color: ${color}; font-size: 1.2rem;">${reactionTime} ms</div>
      <div style="font-size: 0.9rem;">${message}</div>
    `;
    
    // Guardar mejor tiempo
    if (!reactionGame.bestTime || reactionTime < reactionGame.bestTime) {
      reactionGame.bestTime = reactionTime;
      localStorage.setItem('bestReactionTime', reactionTime);
      document.getElementById('bestTime').textContent = reactionTime;
      
      // Guardar en Firebase si est√° logueado
      if (currentUser.isLoggedIn) {
        const bestTimeRef = ref(db, "bestReactionTimes/" + currentUser.id);
        set(bestTimeRef, {
          alias: currentUser.alias,
          time: reactionTime,
          timestamp: Date.now()
        }).catch(error => {
          console.error("Error guardando mejor tiempo:", error);
        });
      }
    }
    
    // Mostrar notificaci√≥n
    showNotification(`Tu tiempo de reacci√≥n: ${reactionTime} ms`, 'info');
  }
  
  // Cerrar sesi√≥n - FUNCIONA CORRECTAMENTE
  async function logout() {
    if (confirm("¬øSeguro que quieres cerrar sesi√≥n del Peri√≥dico Guacari?")) {
      try {
        // Eliminar usuario de Firebase
        if (currentUser.isLoggedIn && currentUser.id) {
          const userRef = ref(db, "users/" + currentUser.id);
          await update(userRef, {
            online: false,
            lastActive: Date.now(),
            updatedAt: Date.now()
          });
        }
      } catch (error) {
        console.error("Error cerrando sesi√≥n en Firebase:", error);
      }
      
      // Limpiar localStorage
      localStorage.removeItem('guacariUser');
      
      // Resetear usuario actual
      currentUser = {
        id: null,
        alias: null,
        isLoggedIn: false
      };
      
      // Actualizar UI
      updateUserUI();
      
      // Mostrar modal de login
      showLoginModal();
      
      // Mostrar notificaci√≥n
      showNotification("Sesi√≥n cerrada correctamente", 'info');
    }
  }
  
  // Funciones de utilidad
  function formatTime(timestamp) {
    if (!timestamp) return "Reci√©n";
    
    const now = Date.now();
    const diff = now - timestamp;
    
    if (diff < 60000) { // Menos de 1 minuto
      return "Ahora mismo";
    } else if (diff < 3600000) { // Menos de 1 hora
      const minutes = Math.floor(diff / 60000);
      return `Hace ${minutes} minuto${minutes !== 1 ? 's' : ''}`;
    } else if (diff < 86400000) { // Menos de 1 d√≠a
      const hours = Math.floor(diff / 3600000);
      return `Hace ${hours} hora${hours !== 1 ? 's' : ''}`;
    } else {
      const date = new Date(timestamp);
      return date.toLocaleDateString('es-ES', {hour: '2-digit', minute:'2-digit'});
    }
  }
  
  function showNotification(message, type = 'info') {
    // Crear notificaci√≥n
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1001;
      animation: slideInRight 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    `;
    
    document.body.appendChild(notification);
    
    // Eliminar despu√©s de 3 segundos
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }
  
  // Permitir enviar comentarios con Enter
  document.addEventListener('keydown', function(e) {
    // Enviar comentario de mood con Enter
    if (e.target.id === 'moodCommentInput' && e.key === 'Enter' && !e.ctrlKey && !e.shiftKey) {
      e.preventDefault();
      postMoodComment();
    }
    
    // Enviar comentario de poll con Enter
    if (e.target.id === 'pollCommentInput' && e.key === 'Enter' && !e.ctrlKey && !e.shiftKey) {
      e.preventDefault();
      postPollComment();
    }
    
    // Enviar comentario de foro con Enter
    if (e.target.id === 'forumCommentInput' && e.key === 'Enter' && !e.ctrlKey && !e.shiftKey) {
      e.preventDefault();
      postForumComment();
    }
    
    // Iniciar sesi√≥n con Enter en el modal
    if (e.target.id === 'modalAliasInput' && e.key === 'Enter') {
      e.preventDefault();
      loginFromModal();
    }
    
    // Iniciar sesi√≥n con Enter en el formulario principal
    if (e.target.id === 'aliasInput' && e.key === 'Enter') {
      e.preventDefault();
      login();
    }
  });
  
  // Actualizar fecha cada minuto
  setInterval(updateDate, 60000);
  
  // Inicializar cuando la p√°gina cargue
  window.addEventListener('DOMContentLoaded', initApp);
  
  // Hacer funciones globales
  window.login = login;
  window.loginFromModal = loginFromModal;
  window.logout = logout;
  window.voteMood = voteMood;
  window.votePoll = votePoll;
  window.postMoodComment = postMoodComment;
  window.postPollComment = postPollComment;
  window.postForumComment = postForumComment;
  window.postReply = postReply;
  window.showReplyForm = showReplyForm;
  window.hideReplyForm = hideReplyForm;
  window.startReactionGame = startReactionGame;
</script>

</body>
</html>